<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>API接口签名验证与参数加密 | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.6632e4e3.css" as="style"><link rel="preload" href="/study-note/assets/js/app.36ae5403.js" as="script"><link rel="preload" href="/study-note/assets/js/2.a329299a.js" as="script"><link rel="preload" href="/study-note/assets/js/45.70d6a23f.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.592e3819.js"><link rel="prefetch" href="/study-note/assets/js/11.4a3c536c.js"><link rel="prefetch" href="/study-note/assets/js/12.ef6ffd6b.js"><link rel="prefetch" href="/study-note/assets/js/13.f177cc62.js"><link rel="prefetch" href="/study-note/assets/js/14.bccdad65.js"><link rel="prefetch" href="/study-note/assets/js/15.07d4a46c.js"><link rel="prefetch" href="/study-note/assets/js/16.edc1994d.js"><link rel="prefetch" href="/study-note/assets/js/17.85d234e0.js"><link rel="prefetch" href="/study-note/assets/js/18.3d4c9688.js"><link rel="prefetch" href="/study-note/assets/js/19.7dcd0753.js"><link rel="prefetch" href="/study-note/assets/js/20.6602f184.js"><link rel="prefetch" href="/study-note/assets/js/21.6d179b01.js"><link rel="prefetch" href="/study-note/assets/js/22.2a60b12b.js"><link rel="prefetch" href="/study-note/assets/js/23.195375d1.js"><link rel="prefetch" href="/study-note/assets/js/24.2f65969c.js"><link rel="prefetch" href="/study-note/assets/js/25.17101bf9.js"><link rel="prefetch" href="/study-note/assets/js/26.2707fbe5.js"><link rel="prefetch" href="/study-note/assets/js/27.d5d9742d.js"><link rel="prefetch" href="/study-note/assets/js/28.62d8a603.js"><link rel="prefetch" href="/study-note/assets/js/29.a7531d5f.js"><link rel="prefetch" href="/study-note/assets/js/3.d05807e0.js"><link rel="prefetch" href="/study-note/assets/js/30.580b9f5c.js"><link rel="prefetch" href="/study-note/assets/js/31.a594e726.js"><link rel="prefetch" href="/study-note/assets/js/32.9d1c1db0.js"><link rel="prefetch" href="/study-note/assets/js/33.322f1225.js"><link rel="prefetch" href="/study-note/assets/js/34.fcd29712.js"><link rel="prefetch" href="/study-note/assets/js/35.3cc41a16.js"><link rel="prefetch" href="/study-note/assets/js/36.d798da07.js"><link rel="prefetch" href="/study-note/assets/js/37.f60cd574.js"><link rel="prefetch" href="/study-note/assets/js/38.de2eef58.js"><link rel="prefetch" href="/study-note/assets/js/39.71d5f07c.js"><link rel="prefetch" href="/study-note/assets/js/4.9a4eead2.js"><link rel="prefetch" href="/study-note/assets/js/40.6540463c.js"><link rel="prefetch" href="/study-note/assets/js/41.05892002.js"><link rel="prefetch" href="/study-note/assets/js/42.57ea4b3c.js"><link rel="prefetch" href="/study-note/assets/js/43.e987ac78.js"><link rel="prefetch" href="/study-note/assets/js/44.c8453269.js"><link rel="prefetch" href="/study-note/assets/js/46.397182aa.js"><link rel="prefetch" href="/study-note/assets/js/47.ac769bd1.js"><link rel="prefetch" href="/study-note/assets/js/48.61ddb0cd.js"><link rel="prefetch" href="/study-note/assets/js/49.ba4697b8.js"><link rel="prefetch" href="/study-note/assets/js/5.c403311f.js"><link rel="prefetch" href="/study-note/assets/js/50.403d6c80.js"><link rel="prefetch" href="/study-note/assets/js/51.3adb3e8a.js"><link rel="prefetch" href="/study-note/assets/js/52.04e3c726.js"><link rel="prefetch" href="/study-note/assets/js/53.f5fdc08d.js"><link rel="prefetch" href="/study-note/assets/js/6.2d6870b8.js"><link rel="prefetch" href="/study-note/assets/js/7.7b5df3ca.js"><link rel="prefetch" href="/study-note/assets/js/8.a9c4a092.js"><link rel="prefetch" href="/study-note/assets/js/9.2194814d.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.6632e4e3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="api接口签名验证与参数加密"><a href="#api接口签名验证与参数加密" class="header-anchor">#</a> API接口签名验证与参数加密</h1> <p>刚开始写代码时，接口都是裸奔的，客户端抓个包，就能知道所有的请求参数和返回参数，对于一些重要的接口，这样是不安全的。</p> <p>后来公司开始对所有业务接口进行参数加密处理，就学习了接口的签名和加密的相关规则，做个记录。</p> <h2 id="_1-问题引出"><a href="#_1-问题引出" class="header-anchor">#</a> 1 问题引出</h2> <p>调用API接口时，请求方和接口提供方之间的通信过程，需要考虑几个问题：</p> <ul><li>请求参数是否被篡改；</li> <li>请求来源是否合法；</li> <li>请求是否具有唯一性；</li></ul> <p><strong>举个例子：</strong></p> <p>客户端 app 调用产品信息查询 api 进行产品查询：</p> <blockquote><p>请求: http://api.test.com/getproducts?key1=value1&amp;key2=value2</p></blockquote> <p>没有进行任何的验证，接口处于裸奔状态，所有人都可以通过这个接口获取到产品列表，导致产品信息泄露。</p> <h2 id="_2-参数签名"><a href="#_2-参数签名" class="header-anchor">#</a> 2 参数签名</h2> <p>首先进行一个小优化：<strong>调用API 时需对请求参数进行签名验证</strong> ，规则如下：</p> <ul><li>将所有入参（sign 除外）按照 &quot;key=value&quot; 的格式拼接起来，并且将拼接以后的字符串以 &quot;&amp;&quot; 字符连接。顺序按首字母升序排列，值为空的不参与签名。将拼接好的字符串做 MD5 签名。</li></ul> <blockquote><p>即：MD5(key1=value1&amp;key2=value2)</p></blockquote> <ul><li>将生成的签名 sign 添加在请求参数中</li></ul> <blockquote><p>新的接口：http://api.test.com/getproducts?key1=value1&amp;key2=value2&amp;sign=...</p></blockquote> <ul><li>后端对请求的 sign 进行校验，需要携带正确的sign才能获取产品数据。</li></ul> <p>但是，只对请求参数进行做 MD5 签名得到的 sign 还是不安全的，别人同样可以做相同的加密操作进行请求 。</p> <h2 id="_3-accesskey-secretkey"><a href="#_3-accesskey-secretkey" class="header-anchor">#</a> 3 AccessKey &amp; SecretKey</h2> <p>进一步优化方法：</p> <p>为开发者分配 <strong>AccessKey</strong>（开发者标识，确保唯一）和 <strong>SecretKey</strong>（用于接口加密)</p> <ol><li><p>请求参数中也携带 AccessKey；</p></li> <li><p>app 和后端约定一个 SecretKey，用于生成签名；</p></li> <li><p><strong>在上述请求参数字符串中尾部加上 SecretKey 组成一个新字符串，再进行 MD5 加密得到签名 sign</strong>。</p> <p>当然也可以使用其他的加密算法</p></li></ol> <blockquote><p>即：MD5(key1=value1&amp;key2=value2secret)</p></blockquote> <p>请求携带参数<strong>AccessKey</strong>和<strong>Sign</strong>，只有拥有合法的身份 AccessKey 和正确的签名 sign 才能放行。这样就解决了身份验证和参数篡改问题。</p> <p>如果参数被篡改，没事，因为别人无法知道 SecretKey，也就无法重新生成新的 sign。</p> <p>注：SecretKey 仅作加密使用, 不参与网络传输，为了保证数据安全请不要在请求参数中使用。</p> <h2 id="_4-请求唯一性保证"><a href="#_4-请求唯一性保证" class="header-anchor">#</a> 4 请求唯一性保证</h2> <p>但是...这样就够了吗？</p> <p>MD5 签名方法可以保证来源及请求参数的合法性，但是请求链接可能会被抓包而造成泄露，人家拿着这个请求链接反复请求，就可以正常获取数据了，即 <strong>重放攻击</strong>，因此仅仅是如上的优化是不够的！</p> <p>再次优化：</p> <ul><li>在如上的请求参数中带上 <strong>时间戳</strong> ，并且把时间戳也作为签名的一部分。在接口提供方对时间戳进行验证，只允许一定时间范围内的请求，假设为 5 分钟。后端先校验时间戳，相差超过 5 分钟的请求直接拒绝。</li></ul> <blockquote><p>新的接口：http://api.test.com/getproducts?key1=value1&amp;key2=value2&amp;timestamp=...&amp;sign=...</p></blockquote> <p>以上可以使用自定义注解 + 拦截器进行实现。</p> <h2 id="_5-参数加密"><a href="#_5-参数加密" class="header-anchor">#</a> 5 参数加密</h2> <h3 id="对称加密"><a href="#对称加密" class="header-anchor">#</a> 对称加密</h3> <p><code>Symmetric Cryptography</code>，是最快速、最简单的一种加密方式，加密（encryption）与解密（decryption）使用同样的密钥（secret key）。</p> <p>常见的对称加密算法如 AES，Advanced Encryption Standard。</p> <p>对称加密的缺点是密钥的管理与分配，即如何发送秘钥。因为在发送密钥的过程中，密钥有很大的风险被拦截。<strong>通常的做法是将对称加密的密钥进行非对称加密，然后传送给需要它的一方。</strong></p> <h3 id="非对称加密"><a href="#非对称加密" class="header-anchor">#</a> 非对称加密</h3> <p><code>Asymmetric Cryptography</code>，使用了一对密钥，**公钥（public key） ** 和 <strong>私钥（private key）</strong>。私钥只能由一方安全保管，不能外泄，而公钥则可以发给任何请求它的人。非对称加密使用这对密钥中的一个进行加密，而解密则需要另一个密钥。私钥是不会通过网络发送出去，因此安全性大大提高。</p> <p>目前最常用的非对称加密算法是 RSA 算法</p> <h3 id="加密方案"><a href="#加密方案" class="header-anchor">#</a> 加密方案</h3> <p>目前采用的加密流程为：</p> <ol><li>为不同的客户端 app 分配了不同的 RSA 加密的公钥，私钥保存在服务器中；</li> <li>客户端 app 随机生成 AES 密钥并通过 RSA 加密放在请求 header 中；</li> <li>服务端使用 RSA  的私钥，解密出 AES 密钥原文，从而解密出请求参数；进行业务处理；</li> <li>使用客户端发过来的 AES 密钥将返回数据加密返回</li></ol> <p>以上流程可以在过滤器中实现。</p> <h2 id="_6-总结"><a href="#_6-总结" class="header-anchor">#</a> 6 总结</h2> <p>接口签名校验和参数加密是非常常见的接口保护手段。</p> <ol><li>签名校验使用了 AccessKey &amp; SecretKey + timestamp 的方式，对请求参数进行 MD5 加密得到签名 sign；</li> <li>参数加密同时使用了 AES 和 RSA 两种加密算法，对称加密的密钥进行非对称加密后传输。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/14/2022, 1:08:51 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study-note/assets/js/app.36ae5403.js" defer></script><script src="/study-note/assets/js/2.a329299a.js" defer></script><script src="/study-note/assets/js/45.70d6a23f.js" defer></script>
  </body>
</html>
