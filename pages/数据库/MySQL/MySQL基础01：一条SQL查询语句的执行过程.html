<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一条SQL查询语句的执行过程 | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.18b2ff20.css" as="style"><link rel="preload" href="/study-note/assets/js/app.6b876f16.js" as="script"><link rel="preload" href="/study-note/assets/js/2.f72d9393.js" as="script"><link rel="preload" href="/study-note/assets/js/18.b191833e.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.d408d918.js"><link rel="prefetch" href="/study-note/assets/js/11.24cad54d.js"><link rel="prefetch" href="/study-note/assets/js/12.c7edb43f.js"><link rel="prefetch" href="/study-note/assets/js/13.05379442.js"><link rel="prefetch" href="/study-note/assets/js/14.4de91857.js"><link rel="prefetch" href="/study-note/assets/js/15.76558b20.js"><link rel="prefetch" href="/study-note/assets/js/16.b5b26512.js"><link rel="prefetch" href="/study-note/assets/js/17.2fdfd012.js"><link rel="prefetch" href="/study-note/assets/js/19.6330142d.js"><link rel="prefetch" href="/study-note/assets/js/20.ce774177.js"><link rel="prefetch" href="/study-note/assets/js/21.623f24cd.js"><link rel="prefetch" href="/study-note/assets/js/22.fc25f660.js"><link rel="prefetch" href="/study-note/assets/js/23.1a55eb92.js"><link rel="prefetch" href="/study-note/assets/js/24.d319381b.js"><link rel="prefetch" href="/study-note/assets/js/25.02e8fe32.js"><link rel="prefetch" href="/study-note/assets/js/26.48a5ce04.js"><link rel="prefetch" href="/study-note/assets/js/27.f5518525.js"><link rel="prefetch" href="/study-note/assets/js/28.efb1b1d5.js"><link rel="prefetch" href="/study-note/assets/js/29.0867237c.js"><link rel="prefetch" href="/study-note/assets/js/3.a5aee981.js"><link rel="prefetch" href="/study-note/assets/js/30.c4d98526.js"><link rel="prefetch" href="/study-note/assets/js/31.2d852896.js"><link rel="prefetch" href="/study-note/assets/js/32.7a0b6574.js"><link rel="prefetch" href="/study-note/assets/js/33.458ee9d2.js"><link rel="prefetch" href="/study-note/assets/js/34.0d54bd77.js"><link rel="prefetch" href="/study-note/assets/js/35.003b16a0.js"><link rel="prefetch" href="/study-note/assets/js/36.e06e7163.js"><link rel="prefetch" href="/study-note/assets/js/37.af1fc340.js"><link rel="prefetch" href="/study-note/assets/js/38.4c77e9d1.js"><link rel="prefetch" href="/study-note/assets/js/39.db0ac20a.js"><link rel="prefetch" href="/study-note/assets/js/4.0cf0b3b5.js"><link rel="prefetch" href="/study-note/assets/js/40.7f7eb429.js"><link rel="prefetch" href="/study-note/assets/js/41.2ac36ee9.js"><link rel="prefetch" href="/study-note/assets/js/42.8ba55a31.js"><link rel="prefetch" href="/study-note/assets/js/43.734b8ee9.js"><link rel="prefetch" href="/study-note/assets/js/44.46c13f90.js"><link rel="prefetch" href="/study-note/assets/js/45.e5f681b1.js"><link rel="prefetch" href="/study-note/assets/js/46.6e7b63bb.js"><link rel="prefetch" href="/study-note/assets/js/5.0559d5c3.js"><link rel="prefetch" href="/study-note/assets/js/6.45c573e9.js"><link rel="prefetch" href="/study-note/assets/js/7.6d5512ae.js"><link rel="prefetch" href="/study-note/assets/js/8.eeea1fd5.js"><link rel="prefetch" href="/study-note/assets/js/9.af70dea1.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.18b2ff20.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据结构与算法" class="mobile-dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  集合
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><a href="/study-note/MySQL.html" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/study-note/MySQL.html" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  操作系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据结构与算法" class="dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据结构与算法" class="mobile-dropdown-title"><span class="title">数据结构与算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  数据结构
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  集合
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="常用框架" class="dropdown-title"><span class="title">常用框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="常用框架" class="mobile-dropdown-title"><span class="title">常用框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/MySQL.html" class="nav-link">
  MyBatis
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  SpringMVC
</a></li><li class="dropdown-item"><!----> <a href="/study-note/Redis.html" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><a href="/study-note/MySQL.html" class="nav-link">
  中间件
</a></div><div class="nav-item"><a href="/study-note/MySQL.html" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一条sql查询语句的执行过程"><a href="#一条sql查询语句的执行过程" class="header-anchor">#</a> 一条SQL查询语句的执行过程</h1> <p>本文是学习 MySQL 的过程中的笔记记录整理。</p> <p>学习资料：  <a href="https://time.geekbang.org/column/intro/100020801" target="_blank" rel="noopener noreferrer">极客时间 MySQL实战45讲-丁奇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>内容包括：</p> <ol><li>MySQL 数据库的基础架构：</li> <li>SQL查询语句的执行过程；</li> <li>连接器、分析器、优化器、执行器、存储引擎等的作用</li></ol> <blockquote><p>买的课，迟早要学完。</p></blockquote> <h2 id="_1-mysql-基础架构"><a href="#_1-mysql-基础架构" class="header-anchor">#</a> 1 MySQL 基础架构</h2> <p>经典的 MySQL 的基本架构示意图：</p> <p><img src="https://image.kongxiao.top/20210806172606.png" alt="img"></p> <p>MySQL 可以分为 <strong>Server 层</strong> 和 <strong>存储引擎层</strong> 两部分。</p> <ul><li><p><strong>Server 层</strong> ：包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。</p></li> <li><p><strong>存储引擎层</strong> ： 负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB (MySQL 5.5.5 版本开始成为了默认存储引擎) 。</p></li></ul> <p><strong>不同的存储引擎共用一个 Server 层</strong></p> <p>建表语句示例：使用 <code>ENGINE=InnoDB</code> 来指定存储引擎，不指定引擎类型，默认使用的就是 InnoDB</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_2-连接器"><a href="#_2-连接器" class="header-anchor">#</a> 2 连接器</h2> <p>连接器 负责跟客户端建立连接、获取权限、维持和管理连接。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 启动MySQLl服务</span>
net start mysql
<span class="token comment"># 连接MySQL</span>
mysql -h<span class="token variable">$ip</span> -P<span class="token variable">$port</span> -u<span class="token variable">$user</span> -p
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果用户名或密码不对，会报错<code>&quot;Access denied for user&quot;</code>，然后客户端程序结束执行。</p> <p>如果用户名密码认证通过，连接器会到权限表里面查出账户所拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。</p> <p>也就是说 <strong>连接建立以后，权限就确定下来；如果发生变化，需要下次重新连接时生效。</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 查看连接情况</span>
<span class="token keyword">show</span> processlist
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://image.kongxiao.top/20210807092605.png" alt="image-20210807092604463"></p> <ul><li>客户端如果长时间无动作，连接器会将其断开。这个时间是由参数 <code>wait_timeout</code> 控制的，默认值是 8 小时，可通过以下指令查看</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'wait_timeout'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://image.kongxiao.top/20210807092719.png" alt="image-20210807092717997"></p> <ul><li>如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒：<code>Lost connection to MySQL server during query</code>，就需要重连</li></ul> <p><strong>长连接与短连接：</strong></p> <ul><li><p>长连接：连接成功后，如果客户端持续有请求，则一直使用同一个连接，（为了提升数据库并发性，可以建立一个数据库连接池）；长连接如果长期闲置，MySQL 会 8 小时后（默认时间）主动断开该连接；</p></li> <li><p>短连接：每次执行完很少的几次查询就断开连接，下次查询再重新建立一个</p></li></ul> <p>但是长时间使用长连接占用内存涨得会特别快， 因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的，这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。</p> <p>解决方案：</p> <ol><li>定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。</li> <li>MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。</li></ol> <p>可以类比 HTTP 的长连接和短连接：  <a href="https://www.cnblogs.com/gotodsp/p/6366163.html" target="_blank" rel="noopener noreferrer">[HTTP长连接、短连接究竟是什么？]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>查看mysql最大连接数：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'max_connections'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_3-查询缓存"><a href="#_3-查询缓存" class="header-anchor">#</a> 3 查询缓存</h2> <p>建立连接完成后，可以开始执行 select 语句，来到第二步：查询缓存</p> <p>MySQL 执行过的查询语句，会以 key-value 对的形式，被直接缓存在内存中，key 是查询的语句，value 是查询的结果。</p> <p>在执行一个查询请求时，会先查询缓，如果能够直接在这个缓存中命中 key，那么就直接返回 value；否则才继续后面的执行阶段。</p> <p>但是缓存带来了额外的开销，每次查询后都要做一次缓存操作，失效后还要销毁。<strong>只要有对一个表的更新，这个表上所有的查询缓存都会被清空</strong>， 对于更新压力大的数据库来说，查询缓存的命中率会非常低。</p> <p>MySQL 提供了&quot;按需使用&quot;的方式。 SQL_CACHE 显式指定，像下面这个语句一样：设置缓存的两个参数：</p> <ul><li><p><code>query_cache_type</code></p></li> <li><p><code>query_cache_size</code></p></li></ul> <p><strong>还可以通过 sql_cache 和 sql_no_cache 来控制某个查询语句是否需要缓存</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> sql_no_cache <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> usr<span class="token punctuation">;</span>
<span class="token keyword">select</span> sql_cache <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> usr<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>MySQL 8.0 版本后移除，因为这个功能不太实用！！</p> <h2 id="_4-分析器"><a href="#_4-分析器" class="header-anchor">#</a> 4 分析器</h2> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> T <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>分析器，包括 <strong>词法分析</strong> 和 <strong>语法分析</strong></p> <ul><li>词法分析：识别出里面的字符串分别是什么，代表什么。MySQL 从输入的 &quot;select&quot; 这个关键字识别出来，这是一个查询语句。把字符串 “T” 识别成“表名 T”，把字符串 “id” 识别成 “列 id” 。</li> <li>语法分析：根据词法分析的结果，语法分析器会根据语法规则，判断输入的这个 SQL 语句是否满足 MySQL 语法。如果不对会报 <code>“You have an error in your SQL syntax”</code></li></ul> <h2 id="_5-优化器"><a href="#_5-优化器" class="header-anchor">#</a> 5 优化器</h2> <p>一条 SQL 语句可能有不同的执行逻辑（或者顺执行顺序），而优化器就是选择最优的执行顺序。</p> <p>在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。</p> <p>但是 优化器判断的有的时候未必是正确的！后续再详细学习下</p> <p>可以使用 explain 指令来查看 SQL 执行计划。</p> <h2 id="_6-执行器"><a href="#_6-执行器" class="header-anchor">#</a> 6 执行器</h2> <p>MySQL 通过分析器知道了要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句</p> <p><strong>开始执行的时候，要先判断一下对这个表 T 有没有执行查询的权限</strong>，如果没有，就会返回没有权限的错误。 (在工程实现上，如果命中查询缓存，会在查询缓存返回结果的时候，做权限验证。查询也会在优化器之前调用 precheck 验证权限)。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> T <span class="token keyword">where</span> ID<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>

ERROR <span class="token number">1142</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: <span class="token keyword">SELECT</span> command denied <span class="token keyword">to</span> <span class="token keyword">user</span> <span class="token string">'b'</span><span class="token variable">@'localhost'</span> <span class="token keyword">for</span> <span class="token keyword">table</span> <span class="token string">'T'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。</p> <p>**为什么对权限的检查不在优化器之前做？**因为有些时候，SQL 语句要操作的表不只是 SQL字面上那些。比如有个触发器，得在执行器阶段（过程中）才能确定，优化器阶段前是无能为力的</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2022, 11:29:32 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/study-note/assets/js/app.6b876f16.js" defer></script><script src="/study-note/assets/js/2.f72d9393.js" defer></script><script src="/study-note/assets/js/18.b191833e.js" defer></script>
  </body>
</html>
