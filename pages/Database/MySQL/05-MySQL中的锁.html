<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>05-MySQL 中的锁 | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.82b8320f.css" as="style"><link rel="preload" href="/study-note/assets/js/app.94e6fb8d.js" as="script"><link rel="preload" href="/study-note/assets/js/2.a329299a.js" as="script"><link rel="preload" href="/study-note/assets/js/16.edc1994d.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.592e3819.js"><link rel="prefetch" href="/study-note/assets/js/11.4a3c536c.js"><link rel="prefetch" href="/study-note/assets/js/12.ef6ffd6b.js"><link rel="prefetch" href="/study-note/assets/js/13.f177cc62.js"><link rel="prefetch" href="/study-note/assets/js/14.76d2c932.js"><link rel="prefetch" href="/study-note/assets/js/15.07d4a46c.js"><link rel="prefetch" href="/study-note/assets/js/17.a3bdaf68.js"><link rel="prefetch" href="/study-note/assets/js/18.cd37fdd5.js"><link rel="prefetch" href="/study-note/assets/js/19.069848e5.js"><link rel="prefetch" href="/study-note/assets/js/20.a022a89e.js"><link rel="prefetch" href="/study-note/assets/js/21.6d179b01.js"><link rel="prefetch" href="/study-note/assets/js/22.2a60b12b.js"><link rel="prefetch" href="/study-note/assets/js/23.195375d1.js"><link rel="prefetch" href="/study-note/assets/js/24.2f65969c.js"><link rel="prefetch" href="/study-note/assets/js/25.17101bf9.js"><link rel="prefetch" href="/study-note/assets/js/26.2707fbe5.js"><link rel="prefetch" href="/study-note/assets/js/27.d5d9742d.js"><link rel="prefetch" href="/study-note/assets/js/28.62d8a603.js"><link rel="prefetch" href="/study-note/assets/js/29.a7531d5f.js"><link rel="prefetch" href="/study-note/assets/js/3.d05807e0.js"><link rel="prefetch" href="/study-note/assets/js/30.580b9f5c.js"><link rel="prefetch" href="/study-note/assets/js/31.a594e726.js"><link rel="prefetch" href="/study-note/assets/js/32.9d1c1db0.js"><link rel="prefetch" href="/study-note/assets/js/33.322f1225.js"><link rel="prefetch" href="/study-note/assets/js/34.fcd29712.js"><link rel="prefetch" href="/study-note/assets/js/35.3cc41a16.js"><link rel="prefetch" href="/study-note/assets/js/36.d798da07.js"><link rel="prefetch" href="/study-note/assets/js/37.f60cd574.js"><link rel="prefetch" href="/study-note/assets/js/38.de2eef58.js"><link rel="prefetch" href="/study-note/assets/js/39.71d5f07c.js"><link rel="prefetch" href="/study-note/assets/js/4.9a4eead2.js"><link rel="prefetch" href="/study-note/assets/js/40.6540463c.js"><link rel="prefetch" href="/study-note/assets/js/41.05892002.js"><link rel="prefetch" href="/study-note/assets/js/42.57ea4b3c.js"><link rel="prefetch" href="/study-note/assets/js/43.e987ac78.js"><link rel="prefetch" href="/study-note/assets/js/44.e1844116.js"><link rel="prefetch" href="/study-note/assets/js/45.70d6a23f.js"><link rel="prefetch" href="/study-note/assets/js/46.397182aa.js"><link rel="prefetch" href="/study-note/assets/js/47.ac769bd1.js"><link rel="prefetch" href="/study-note/assets/js/48.61ddb0cd.js"><link rel="prefetch" href="/study-note/assets/js/49.ba4697b8.js"><link rel="prefetch" href="/study-note/assets/js/5.c403311f.js"><link rel="prefetch" href="/study-note/assets/js/50.403d6c80.js"><link rel="prefetch" href="/study-note/assets/js/51.fb3823c6.js"><link rel="prefetch" href="/study-note/assets/js/52.9fa1b3b1.js"><link rel="prefetch" href="/study-note/assets/js/53.888e927a.js"><link rel="prefetch" href="/study-note/assets/js/6.2d6870b8.js"><link rel="prefetch" href="/study-note/assets/js/7.7b5df3ca.js"><link rel="prefetch" href="/study-note/assets/js/8.a9c4a092.js"><link rel="prefetch" href="/study-note/assets/js/9.2194814d.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.82b8320f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/study-note/pages/Database/MySQL/" class="sidebar-heading clickable router-link-active open"><span>MySQL 实战 45 讲 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-note/pages/Database/MySQL/01-MySQL的基础架构.html" class="sidebar-link">01-MySQL 的基础架构</a></li><li><a href="/study-note/pages/Database/MySQL/02-MySQL的日志系统.html" class="sidebar-link">02-MySQL 的日志系统</a></li><li><a href="/study-note/pages/Database/MySQL/03-事务隔离.html" class="sidebar-link">03-事务隔离</a></li><li><a href="/study-note/pages/Database/MySQL/04-深入浅出索引.html" class="sidebar-link">04-深入浅出索引</a></li><li><a href="/study-note/pages/Database/MySQL/05-MySQL中的锁.html" class="active sidebar-link">05-MySQL 中的锁</a></li><li><a href="/study-note/pages/Database/MySQL/06-MVCC.html" class="sidebar-link">06-MVCC</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_05-mysql-中的锁"><a href="#_05-mysql-中的锁" class="header-anchor">#</a> 05-MySQL 中的锁</h1> <p>课程链接：</p> <ul><li><a href="https://time.geekbang.org/column/article/69862" target="_blank" rel="noopener noreferrer">MySQL 实战 45 讲 06 | 全局锁和表锁 ：给表加个字段怎么有这么多阻碍？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://time.geekbang.org/column/article/70215" target="_blank" rel="noopener noreferrer">MySQL 实战 45 讲 07 | 行锁功过：怎么减少行锁对性能的影响？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>数据库锁设计的初衷是处理并发问题，内容包括：</p> <ul><li>全局锁</li> <li>表级锁
<ul><li>表锁</li> <li>元数据锁</li></ul></li> <li>行锁
<ul><li>两阶段锁</li> <li>死锁和死锁检测</li></ul></li></ul> <h2 id="全局锁"><a href="#全局锁" class="header-anchor">#</a> 全局锁</h2> <p>给整个数据库实例加锁，整个数据库处于只读状态，客户端断开的时候自动释放。命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># FTWRL</span>
Flush tables with <span class="token builtin class-name">read</span> lock 

<span class="token comment"># 释放锁</span>
unlock tables
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>加全局锁后，以下语句会被阻塞：</p> <ul><li>数据定义语句（DDL，包括建表、修改表结构等）</li> <li>数据操作语句（DML，数据的增删改）</li> <li>更新类事务的提交语句</li></ul> <h3 id="全库逻辑备份"><a href="#全库逻辑备份" class="header-anchor">#</a> 全库逻辑备份</h3> <p>全局锁的典型使用场景是，做<strong>全库逻辑备份</strong>。</p> <p>需要保证备份的得到的库是一个逻辑时间点，否则数据可能会不一致。通过 FTWRL 确保不会有其他线程对数据库做更新，然后对整个库做备份。但是备份过程中如果整个库完全处于只读状态，会影响到业务。</p> <p>另外一种方式，在可重复读隔离级别下开启一个事务也能够拿到一致性视图。官方自带的逻辑备份工具 <code>mysqldump</code>， 使用参数<code>-single-transaction</code>，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。</p> <p>有一致性视图功能，为什么还需要 FTWRL ？</p> <p>因为<strong>需要引擎要支持这个隔离级别</strong>。对于不支持事务的引擎比如 MyISAM，如果备份过程中有更新，总是只能取到最新的数据，就破坏了备份的一致性。</p> <p>使用 <code>set global readonly=true</code> 也可以让全库进入只读状态，但还是会建议用 FTWRL 方式，原因：</p> <ul><li>readonly 的值可能会被用来做其他逻辑，比如用来判断一个库是主库还是备库，修改 global 变量的方式影响面更大；</li> <li>在异常处理机制上有差异。执行 FTWRL 命令之后由于客户端发生异常断开，全局锁会自动释放；而将整个库设置为 readonly 之后，如果客户端发生异常，则数据库就会一直保持 readonly 状态</li></ul> <h2 id="表级锁"><a href="#表级锁" class="header-anchor">#</a> 表级锁</h2> <h3 id="表锁"><a href="#表锁" class="header-anchor">#</a> 表锁</h3> <p>语法：</p> <ul><li>加表锁：<code>lock tables ... read/write</code>。read 是共享锁， write 是排它锁。</li> <li>释放锁：<code>unlock tables</code></li></ul> <p>特点：不仅会限制别的线程的读写，也限定了本线程接下来的操作对象。</p> <p>例如在某个线程 A 中执行 <code>lock tables t1 read, t2 write;</code>则其他线程写 t1、读写 t2 的语句都会被阻塞。同时，线程 A 在执行 <code>unlock tables</code> 之前，也只能执行读 t1、读写 t2 的操作，也不能访问其他表。</p> <h3 id="mdl"><a href="#mdl" class="header-anchor">#</a> MDL</h3> <p><strong>元数据锁</strong>（metadata lock，MDL）是 server 层的锁，也是表级锁，主要用于隔离 DML 和 DDL 操作之间的干扰。在 MySQL 5.5 版本中引入了 MDL，不需要显式使用，在访问一个表的时候会被自动加上。用于保证读写的正确性。</p> <ul><li>当对一个表做增删改查操作的时候，加 MDL 读锁；</li> <li>当要<strong>对表做结构变更操作</strong>的时候，加 MDL 写锁；</li> <li>读锁之间不互斥，加读锁则所有线程可正常读元数据，不影响增删改查操作，只是不能修改表结构；</li> <li>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。加写锁则只有拥有锁的线程可以读写元数据，也就是修改表结构，其它线程不能执行任何操作，包括修改表结构与增删改查。</li></ul> <p>事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，<strong>而会等到整个事务提交后再释放。</strong></p> <h3 id="如何安全给表加字段"><a href="#如何安全给表加字段" class="header-anchor">#</a> 如何安全给表加字段</h3> <p>一个案例：给一个小表加个字段导致整个库挂了。</p> <p><img src="http://image.kongxiao.top/20221110230051.png" alt="image-20221110230043373"></p> <ol><li>session A 先启动，这时候会对表 t 加一个 MDL 读锁；</li> <li>由于 session B 需要的也是 MDL 读锁，因此可以正常执行；</li> <li>session A 的 MDL 读锁还没有释放，而 session C 需要 MDL 写锁，因此只能被阻塞；</li> <li>之后所有要在表 t 上新申请 MDL 读锁的请求也会被 session C 阻塞。所有对表的增删改查操作都需要先申请 MDL 读锁，就都被锁住，等于这个表现在完全不可读写了；</li> <li>如果某个表上的查询语句频繁，而且客户端有重试机制，即超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</li></ol> <blockquote><p>参考文章：<a href="https://blog.csdn.net/q2878948/article/details/96430129" target="_blank" rel="noopener noreferrer">mysql MDL读写锁阻塞，以及online ddl造成的“插队”现象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>申请 MDL 锁的操作会形成一个队列，<strong>队列中写锁获取优先级高于读锁</strong>。一旦出现写锁等待，不但当前操作会被阻塞，同时还会阻塞后续该表的所有操作。事务一旦申请到 MDL 锁后，直到事务执行完才会将锁释放</p></blockquote> <p>如何安全给表加字段：</p> <ul><li><p>首先要解决长事务，事务不提交，就会一直占着 MDL 锁。查到当前执行中的事务：<code>SELECT * FROM information_schema.innodb_trx</code>。如果要做 DDL 变更的表刚好有长事务在执行，要考虑先暂停 DDL，或者 kill 掉这个长事务；</p></li> <li><p>要变更一个数据量不大的热点表，这时 kill 未必管用，因为新的请求马上就来了。可以在 <code>alter table</code> 语句里面设定等待时间，如果在这个指定的等待时间里面能够拿到 MDL 写锁最好，拿不到也不要阻塞后面的业务语句，先放弃。之后再通过重试命令重复这个过程。</p></li></ul> <h2 id="行锁"><a href="#行锁" class="header-anchor">#</a> 行锁</h2> <p>锁住整个表的影响面太大，需要更细粒度的锁。</p> <p>MySQL 的行锁是在引擎层由各个引擎自己实现的。<strong>MyISAM 仅支持表锁，而 InnoDB 引擎支持行锁。</strong></p> <p>行锁的实现是通过给索引上的索引项添加锁实现的，故只有当执行的脚本走索引时，InnoDB 才会使用行锁，否则InnoDB 只能使用元数据锁 MDL。</p> <h3 id="两阶段锁"><a href="#两阶段锁" class="header-anchor">#</a> 两阶段锁</h3> <p>两阶段锁协议：在 InnoDB 事务中，行锁是在语句执行时才加上的，不是事务开始就加上，但释放是统一在事务结束时才释放。</p> <p><strong>对于高并发的行记录的操作语句可以尽可能的安排到最后面，以减少锁等待的时间，提高并发性能。</strong></p> <h3 id="死锁和死锁检测"><a href="#死锁和死锁检测" class="header-anchor">#</a> 死锁和死锁检测</h3> <p>死锁：当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态。</p> <p>当出现死锁以后，有两种策略：</p> <ul><li>一是直接进入等待，直到超时。超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置，默认50 s。对于在线服务来说，这个等待时间往往是无法接受的；但是超时时间设置太短的话，会出现很多误伤。</li> <li>二是发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。参数 <code>innodb_deadlock_detect</code> 默认为 on，表示开启这个逻辑。</li></ul> <p>主动死锁检测有额外负担。每当一个事务被锁时，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁。</p> <p>减少死锁的主要方向，就是控制访问相同资源的并发事务量。</p> <h3 id="热点行更新"><a href="#热点行更新" class="header-anchor">#</a> 热点行更新</h3> <p>如果所有事务都要更新同一行，每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，时间复杂度是 O(n) 。</p> <p>假设有 1000 个并发线程要同时更新同一行，那么死锁检测操作就是 100 万这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的 CPU 资源。因此会看到 CPU 利用率很高，但是每秒却执行不了几个事务。</p> <p>解决策略：</p> <ol><li>确保业务上不会产生死锁，直接将死锁检测关闭，弊端是可能会出现大量的超时，对业务有损的；</li> <li>在数据库中间件中统一对更新同一行的请求进行排队，控制并发度；</li> <li>拆行，将一行拆成逻辑上的多行来减少锁冲突；有点分段锁的意思，但是需要根据业务逻辑做详细设计。</li></ol> <hr> <p>思考题 1： 备份一般都会在备库上执行，在用 <code>–single-transaction</code> 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象？</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 设置 RR 隔离级别 </span>
Q1: <span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">REPEATABLE</span> <span class="token keyword">READ</span><span class="token punctuation">;</span>
<span class="token comment"># 启动事务,得到一个一致性视图</span>
Q2: <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span>  <span class="token keyword">WITH</span> <span class="token keyword">CONSISTENT</span> <span class="token keyword">SNAPSHOT</span>；
<span class="token comment">/* other tables */</span>
<span class="token comment"># 设置一个保存点</span>
Q3: <span class="token keyword">SAVEPOINT</span> sp<span class="token punctuation">;</span>
<span class="token comment">/* 时刻 1 */</span>
<span class="token comment"># 拿到表结构</span>
Q4: <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token comment">/* 时刻 2 */</span>
<span class="token comment"># 导出数据</span>
Q5: <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token comment">/* 时刻 3 */</span>
<span class="token comment"># 回滚到 SAVEPOINT sp，释放锁</span>
Q6: <span class="token keyword">ROLLBACK</span> <span class="token keyword">TO</span> <span class="token keyword">SAVEPOINT</span> sp<span class="token punctuation">;</span>
<span class="token comment">/* 时刻 4 */</span>
<span class="token comment">/* other tables */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>分析以上 4 个不同时刻，DDL 从主库传过来的效果。</p> <p>答案：</p> <ol><li>如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是 DDL 后的表结构；</li> <li>如果在“时刻 2”到达，则表结构被改过，Q5 执行的时候，报 <code>Table definition has changed, please retry transaction</code>，现象：mysqldump 终止；</li> <li>如果在“时刻 2”和“时刻 3”之间到达，mysqldump 占着 t1 的 MDL 读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成。</li> <li>从“时刻 4”开始，mysqldump 释放了 MDL 读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。</li></ol> <hr> <p>思考题 2：如果要删除一个表里面的前 10000 行数据，以下哪种方法更好：</p> <ul><li>第一种，直接执行 delete from T limit 10000</li> <li>第二种，在一个连接中循环执行 20 次 delete from T limit 500</li> <li>第三种，在 20 个连接中同时执行 delete from T limit 500</li></ul> <p>答案：</p> <ul><li>第二种方式更好。串行化执行，将相对长的事务分成多次相对短的事务，则每次事务占用锁的时间相对较短。</li> <li>第一种方式：单个语句占用时间长，锁的时间也比较长；而且大事务还会导致主从延迟。</li> <li>第三种方式：人为自己制造锁竞争，加剧并发量。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/15/2022, 3:42:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-note/pages/Database/MySQL/04-深入浅出索引.html" class="prev">
        04-深入浅出索引
      </a></span> <span class="next"><a href="/study-note/pages/Database/MySQL/06-MVCC.html">
        06-MVCC
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study-note/assets/js/app.94e6fb8d.js" defer></script><script src="/study-note/assets/js/2.a329299a.js" defer></script><script src="/study-note/assets/js/16.edc1994d.js" defer></script>
  </body>
</html>
