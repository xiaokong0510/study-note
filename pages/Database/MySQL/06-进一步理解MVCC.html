<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>06-进一步理解MVCC | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.6632e4e3.css" as="style"><link rel="preload" href="/study-note/assets/js/app.36ae5403.js" as="script"><link rel="preload" href="/study-note/assets/js/2.a329299a.js" as="script"><link rel="preload" href="/study-note/assets/js/17.85d234e0.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.592e3819.js"><link rel="prefetch" href="/study-note/assets/js/11.4a3c536c.js"><link rel="prefetch" href="/study-note/assets/js/12.ef6ffd6b.js"><link rel="prefetch" href="/study-note/assets/js/13.f177cc62.js"><link rel="prefetch" href="/study-note/assets/js/14.bccdad65.js"><link rel="prefetch" href="/study-note/assets/js/15.07d4a46c.js"><link rel="prefetch" href="/study-note/assets/js/16.edc1994d.js"><link rel="prefetch" href="/study-note/assets/js/18.3d4c9688.js"><link rel="prefetch" href="/study-note/assets/js/19.7dcd0753.js"><link rel="prefetch" href="/study-note/assets/js/20.6602f184.js"><link rel="prefetch" href="/study-note/assets/js/21.6d179b01.js"><link rel="prefetch" href="/study-note/assets/js/22.2a60b12b.js"><link rel="prefetch" href="/study-note/assets/js/23.195375d1.js"><link rel="prefetch" href="/study-note/assets/js/24.2f65969c.js"><link rel="prefetch" href="/study-note/assets/js/25.17101bf9.js"><link rel="prefetch" href="/study-note/assets/js/26.2707fbe5.js"><link rel="prefetch" href="/study-note/assets/js/27.d5d9742d.js"><link rel="prefetch" href="/study-note/assets/js/28.62d8a603.js"><link rel="prefetch" href="/study-note/assets/js/29.a7531d5f.js"><link rel="prefetch" href="/study-note/assets/js/3.d05807e0.js"><link rel="prefetch" href="/study-note/assets/js/30.580b9f5c.js"><link rel="prefetch" href="/study-note/assets/js/31.a594e726.js"><link rel="prefetch" href="/study-note/assets/js/32.9d1c1db0.js"><link rel="prefetch" href="/study-note/assets/js/33.322f1225.js"><link rel="prefetch" href="/study-note/assets/js/34.fcd29712.js"><link rel="prefetch" href="/study-note/assets/js/35.3cc41a16.js"><link rel="prefetch" href="/study-note/assets/js/36.d798da07.js"><link rel="prefetch" href="/study-note/assets/js/37.f60cd574.js"><link rel="prefetch" href="/study-note/assets/js/38.de2eef58.js"><link rel="prefetch" href="/study-note/assets/js/39.71d5f07c.js"><link rel="prefetch" href="/study-note/assets/js/4.9a4eead2.js"><link rel="prefetch" href="/study-note/assets/js/40.6540463c.js"><link rel="prefetch" href="/study-note/assets/js/41.05892002.js"><link rel="prefetch" href="/study-note/assets/js/42.57ea4b3c.js"><link rel="prefetch" href="/study-note/assets/js/43.e987ac78.js"><link rel="prefetch" href="/study-note/assets/js/44.c8453269.js"><link rel="prefetch" href="/study-note/assets/js/45.70d6a23f.js"><link rel="prefetch" href="/study-note/assets/js/46.397182aa.js"><link rel="prefetch" href="/study-note/assets/js/47.ac769bd1.js"><link rel="prefetch" href="/study-note/assets/js/48.61ddb0cd.js"><link rel="prefetch" href="/study-note/assets/js/49.ba4697b8.js"><link rel="prefetch" href="/study-note/assets/js/5.c403311f.js"><link rel="prefetch" href="/study-note/assets/js/50.403d6c80.js"><link rel="prefetch" href="/study-note/assets/js/51.3adb3e8a.js"><link rel="prefetch" href="/study-note/assets/js/52.04e3c726.js"><link rel="prefetch" href="/study-note/assets/js/53.f5fdc08d.js"><link rel="prefetch" href="/study-note/assets/js/6.2d6870b8.js"><link rel="prefetch" href="/study-note/assets/js/7.7b5df3ca.js"><link rel="prefetch" href="/study-note/assets/js/8.a9c4a092.js"><link rel="prefetch" href="/study-note/assets/js/9.2194814d.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.6632e4e3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/study-note/pages/Database/MySQL/" class="sidebar-heading clickable router-link-active open"><span>MySQL 实战 45 讲 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-note/pages/Database/MySQL/01-MySQL的基础架构.html" class="sidebar-link">01-MySQL 的基础架构</a></li><li><a href="/study-note/pages/Database/MySQL/02-MySQL的日志系统.html" class="sidebar-link">02-MySQL 的日志系统</a></li><li><a href="/study-note/pages/Database/MySQL/03-事务隔离.html" class="sidebar-link">03-事务隔离</a></li><li><a href="/study-note/pages/Database/MySQL/04-深入浅出索引.html" class="sidebar-link">04-深入浅出索引</a></li><li><a href="/study-note/pages/Database/MySQL/05-MySQL中的锁.html" class="sidebar-link">05-MySQL 中的锁</a></li><li><a href="/study-note/pages/Database/MySQL/06-进一步理解MVCC.html" class="active sidebar-link">06-进一步理解MVCC</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_06-进一步理解mvcc"><a href="#_06-进一步理解mvcc" class="header-anchor">#</a> 06-进一步理解MVCC</h1> <p>课程链接：</p> <ul><li><a href="https://time.geekbang.org/column/article/70562" target="_blank" rel="noopener noreferrer">MySQL 实战 45 讲 08 | 事务到底是隔离的还是不隔离的？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>内容包括：</p> <ul><li>一致性视图、当前读、快照读</li> <li>MVCC 里的快照</li> <li>ReadView 读视图</li></ul> <h2 id="一致性读视图"><a href="#一致性读视图" class="header-anchor">#</a> 一致性读视图</h2> <p>可重复读隔离级别下，视图在事务启动时就创建好，整个事务期间都看到的是<strong>事务刚刚启动时候的视图</strong>。</p> <p>因为行锁，事务在执行过程中可能需要等待别的事务更新同一行，那这时候如果该事务也要更新，看到的还是事务刚刚创建时事务的状态吗？ 显然不是，这里的关键就是<strong>对于更新操作来说，需要当前读。</strong></p> <p>在 MySQL 里，有两个“视图”的概念：</p> <ol><li><p><strong>view</strong> ：一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果。</p> <p>创建视图的语法是 <code>create view …</code>，查询方法与表一样。</p></li> <li><p><strong>一致性视图</strong>：InnoDB 在实现 MVCC 时用到，即 consistent read view，用于支持 RC（Read Committed，读提交）和 RR（Repeatable Read，可重复读）隔离级别的实现。</p> <p>consistent read view 没有物理结构，作用是事务执行期间用来定义“我能看到什么数据”。通过高低水位，数据版本号，undo log来进行判断数据可见性，达到 MVCC 目的。</p></li></ol> <h2 id="mvcc-里的快照"><a href="#mvcc-里的快照" class="header-anchor">#</a> MVCC 里的快照</h2> <p>在可重复读隔离级别下，事务在启动的时候就拍了个快照，这个快照是基于整库的。但是并不需要拷贝出全库的数据，通过 undo log 版本链实现的。</p> <p><strong>InnoDB 利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力。</strong></p> <h3 id="事务-id"><a href="#事务-id" class="header-anchor">#</a> 事务 ID</h3> <p>InnoDB 里面每个事务有一个唯一的事务 ID： <strong>transaction id</strong>，在事务开始时向 InnoDB 的事务系统申请，按申请顺序严格递增。</p> <p>在 MySQL 的数据表中，每条记录有 2 个隐藏字段：</p> <ul><li><strong>row_trx_id</strong> ：创建或者最后一次修改该记录的 transaction id</li> <li><strong>roll_pointer</strong>：回滚指针，指向该行数据上一个版本的 undo log</li></ul> <h3 id="undo-log-版本链"><a href="#undo-log-版本链" class="header-anchor">#</a> undo log 版本链</h3> <p>每次修改某行记录时，会把 undo 日志地址赋值给 roll_pointer 隐藏列，将一行数据连接成一个版本链，然后各个事务通过当前的事务 ID 和数据行的版本链进行对比，拿到它该读的版本数据。</p> <p>一个记录被多个事务连续更新后的状态如下图所示。</p> <p><img src="http://image.kongxiao.top/20221116231700.png" alt="image-20221116231659110"></p> <ul><li>虚线框里是同一行数据的 4 个版本，当前最新版本是 V4，k 的值是 22，它是被 transaction id 为 25 的事务更新的，因此它的 row trx_id 也是 25</li> <li>三个虚线箭头就是 undo log；而 V1、V2、V3 并不是物理上真实存在的，而是每次需要的时候根据当前版本和 undo log 计算出来的。比如，需要 V2 的时候，就是通过 V4 依次执行 U3、U2 算出来。</li></ul> <p>按照可重复读的定义，一个事务在启动时：</p> <ul><li>以其启动的时刻为准，<strong>能够看到所有已经提交的事务结果</strong>；如果是其启动以后才生成的，就不认，必须要找到它的上一个版本，如果上一个版本也不可见，那就继续往前找；</li> <li>这个事务执行期间，其他事务的更新对它不可见；</li> <li>如果是这个事务自己更新的数据，它自己还是要认。</li></ul> <p>参考文档：<a href="https://www.51cto.com/article/641019.html" target="_blank" rel="noopener noreferrer">一文搞懂Undo Log版本链与ReadView机制如何让事务读取到该读的数据<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="readview-读视图"><a href="#readview-读视图" class="header-anchor">#</a> ReadView 读视图</h3> <p>InnoDB 为每个事务构造了一个数组，<strong>用来保存这个事务启动瞬间，当前正在活跃的所有事务 ID</strong>，活跃指的就是，启动了但还没提交。</p> <ul><li><strong>低水位</strong>：数组里面事务 ID 的最小值</li> <li>高水位：当前系统里面已经创建过的事务 ID 的最大值加 1</li></ul> <p>这个视图数组和高水位，就组成了当前事务的<strong>一致性视图（read-view）</strong>。</p> <h3 id="可见性判断"><a href="#可见性判断" class="header-anchor">#</a> 可见性判断</h3> <p>数据版本的可见性规则，就是基于数据的 row trx_id 和这个一致性视图的对比结果得到的。</p> <p><img src="http://image.kongxiao.top/20221116232555.png" alt="image-20221116232554202"></p> <p>对于当前事务的启动瞬间来说，一个数据版本的 row trx_id，有以下几种可能：</p> <ul><li>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</li> <li>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</li> <li>如果落在黄色部分，那就包括两种情况：
<ul><li>若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；</li> <li>若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。</li></ul></li></ul> <h3 id="完整案例分析"><a href="#完整案例分析" class="header-anchor">#</a> 完整案例分析</h3> <p>事务启动时机：</p> <ul><li>使用 <code>begin/start transaction</code> ，<strong>在执行到它之后的第一个操作 InnoDB 表的语句，事务才真正启动</strong>；一致性视图是在执行第一个快照读语句时创建的；</li> <li>使用 <code>start transaction with consistent snapshot</code> 可以马上启动一个事务，一致性视图是在执行改语句时创建的。</li></ul> <p>案例：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>k<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t<span class="token punctuation">(</span>id<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="http://image.kongxiao.top/20221117233131.png" alt="image-20221117233130908"></p> <p>假设：</p> <ul><li>事务 A 开始前，系统里面只有一个活跃事务 ID 是 99；</li> <li>事务 A、B、C 的版本号分别是 100、101、102，且当前系统里只有这四个事务；</li> <li>三个事务开始前，(1,1）这一行数据的 row trx_id 是 90。</li></ul> <p><img src="http://image.kongxiao.top/20221117233304.png" alt="image-20221117233303581"></p> <p>操作过程分析：</p> <ol><li>事务 C 把数据从 (1,1) 改成了 (1,2)，此时数据的最新版本（即 row trx_id）是 102，90 成为历史版本；</li> <li>事务 B 把数据从 (1,2) 改成了 (1,3)，此时数据的 row trx_id 是 101，而 102 又成为了历史版本；</li> <li>在事务 A 查询的时候，事务 B 还没有提交，但是它生成的 (1,3) 这个版本已经变成当前版本了。这个版本对事务 A 必须是不可见的，否则就变成脏读了。</li></ol> <p>读数据都是从当前版本读起的，事务 A 查询语句的读数据流程：</p> <ul><li>找到 (1,3) 的时候，判断出 row trx_id=101，比高水位大，处于红色区域，不可见；</li> <li>找到上一个历史版本，row trx_id=102，比高水位大，处于红色区域，不可见；</li> <li>再往前找到了（1,1)，它的 row trx_id=90，比低水位小，处于绿色区域，可见</li></ul> <p>虽然期间这一行数据被修改过，但是事务 A 不论在什么时候查询，看到这行数据的结果都是一致的，称之为<strong>一致性读</strong>。</p> <blockquote><p>总结：</p> <p>一个数据版本，对于一个事务视图来说，除了自己的更新总是可见以外，有三种情况：</p> <ul><li>版本未提交，不可见；</li> <li>版本已提交，但是是在视图创建后提交的，不可见；</li> <li>版本已提交，而且是在视图创建前提交的，可见。</li></ul></blockquote> <h2 id="更新逻辑"><a href="#更新逻辑" class="header-anchor">#</a> 更新逻辑</h2> <p>更新数据都是先读后写的，而这个读，只能读当前的值，即**“当前读”（current read）**。</p> <h3 id="当前读"><a href="#当前读" class="header-anchor">#</a> 当前读</h3> <ul><li>读取的是最新版本, 并且对读取的记录加锁, 阻塞其他事务同时改动相同记录；</li> <li>触发方式：
<ul><li><code>select...lock in share mode</code>（读锁）</li> <li><code>select...for update</code>（写锁）</li> <li><code>update</code> , <code>delete</code> , <code>insert</code></li></ul></li> <li>通过 next-key 锁 (行记录锁+Gap 间隙锁) 实现</li></ul> <h3 id="快照读"><a href="#快照读" class="header-anchor">#</a> 快照读</h3> <ul><li>读取的是历史版本的记录；</li> <li>RC 隔离级别，每次 select 都生成一个快照读；</li> <li>RR 隔离级别，开启事务后第一个 select 语句才是快照读的地方；</li> <li>通过 undolog 实现</li></ul> <h3 id="事务的可重复读"><a href="#事务的可重复读" class="header-anchor">#</a> 事务的可重复读</h3> <ol><li>可重复读的核心就是一致性读（consistent read），而事务更新数据的时候，只能用当前读。如果当前的记录的行锁被其他事务占着的话，就需要进入锁等待；</li> <li>读已提交和可重复的逻辑类似，主要区别为：
<ul><li>RR 级别下，只需要事务开始的时候创建一致性视图，之后事务里的其他查询都是用这个一致性视图</li> <li>RC 级别下，每个语句执行前都会重新算出一个新的视图。</li></ul></li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>InnoDB 的行数据有多个版本，每个数据版本都有自己的 row trx_id，这个事务或者语句有自己的一致性视图。普通查询语句是一致性读，一致性读会根据 row trx_id 和一致性视图确定数据版本的可见性：</p> <ol><li>可重复读：查询只承认在事务启动前的就已经提交完成的数据。</li> <li>读已提交：查询只承认在语句启动前就已经提交完成的数据。</li> <li>当前读，总是读取当前已经提交完成的最新版本。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/29/2022, 2:02:43 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-note/pages/Database/MySQL/05-MySQL中的锁.html" class="prev">
        05-MySQL 中的锁
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study-note/assets/js/app.36ae5403.js" defer></script><script src="/study-note/assets/js/2.a329299a.js" defer></script><script src="/study-note/assets/js/17.85d234e0.js" defer></script>
  </body>
</html>
