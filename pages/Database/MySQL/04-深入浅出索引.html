<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>04-深入浅出索引 | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.de699857.css" as="style"><link rel="preload" href="/study-note/assets/js/app.663c6fe1.js" as="script"><link rel="preload" href="/study-note/assets/js/2.f98b8d51.js" as="script"><link rel="preload" href="/study-note/assets/js/15.83d11e46.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.9e21989e.js"><link rel="prefetch" href="/study-note/assets/js/11.79ce348c.js"><link rel="prefetch" href="/study-note/assets/js/12.1da3b7cc.js"><link rel="prefetch" href="/study-note/assets/js/13.fd6c2b7b.js"><link rel="prefetch" href="/study-note/assets/js/14.da4983da.js"><link rel="prefetch" href="/study-note/assets/js/16.9d0b0239.js"><link rel="prefetch" href="/study-note/assets/js/17.4e2f3f59.js"><link rel="prefetch" href="/study-note/assets/js/18.8d7f248a.js"><link rel="prefetch" href="/study-note/assets/js/19.2777d721.js"><link rel="prefetch" href="/study-note/assets/js/20.88a0bf51.js"><link rel="prefetch" href="/study-note/assets/js/21.5dd228e5.js"><link rel="prefetch" href="/study-note/assets/js/22.fe540fd2.js"><link rel="prefetch" href="/study-note/assets/js/23.716de175.js"><link rel="prefetch" href="/study-note/assets/js/24.2331115c.js"><link rel="prefetch" href="/study-note/assets/js/25.65c5e6bc.js"><link rel="prefetch" href="/study-note/assets/js/26.a2a74be0.js"><link rel="prefetch" href="/study-note/assets/js/27.105738b7.js"><link rel="prefetch" href="/study-note/assets/js/28.c952044f.js"><link rel="prefetch" href="/study-note/assets/js/29.161f270e.js"><link rel="prefetch" href="/study-note/assets/js/3.c3d45618.js"><link rel="prefetch" href="/study-note/assets/js/30.f6d94e9f.js"><link rel="prefetch" href="/study-note/assets/js/31.4aae0c0d.js"><link rel="prefetch" href="/study-note/assets/js/32.f529536e.js"><link rel="prefetch" href="/study-note/assets/js/33.19715b11.js"><link rel="prefetch" href="/study-note/assets/js/34.69ec9768.js"><link rel="prefetch" href="/study-note/assets/js/35.842384d8.js"><link rel="prefetch" href="/study-note/assets/js/36.6c9b276c.js"><link rel="prefetch" href="/study-note/assets/js/37.713d806d.js"><link rel="prefetch" href="/study-note/assets/js/38.469e6a11.js"><link rel="prefetch" href="/study-note/assets/js/39.dc32b2ef.js"><link rel="prefetch" href="/study-note/assets/js/4.99aeaaa0.js"><link rel="prefetch" href="/study-note/assets/js/40.91d6a4bd.js"><link rel="prefetch" href="/study-note/assets/js/41.667400b6.js"><link rel="prefetch" href="/study-note/assets/js/42.4d07c690.js"><link rel="prefetch" href="/study-note/assets/js/43.27a90e35.js"><link rel="prefetch" href="/study-note/assets/js/44.bf600787.js"><link rel="prefetch" href="/study-note/assets/js/45.908a028e.js"><link rel="prefetch" href="/study-note/assets/js/46.9ae494ba.js"><link rel="prefetch" href="/study-note/assets/js/47.ab8a8687.js"><link rel="prefetch" href="/study-note/assets/js/48.fd13de98.js"><link rel="prefetch" href="/study-note/assets/js/49.baf06177.js"><link rel="prefetch" href="/study-note/assets/js/5.d14182a7.js"><link rel="prefetch" href="/study-note/assets/js/50.3e2357d8.js"><link rel="prefetch" href="/study-note/assets/js/51.311235d0.js"><link rel="prefetch" href="/study-note/assets/js/52.ca17cc03.js"><link rel="prefetch" href="/study-note/assets/js/53.b2a48ac8.js"><link rel="prefetch" href="/study-note/assets/js/6.e4e98157.js"><link rel="prefetch" href="/study-note/assets/js/7.a2815fd5.js"><link rel="prefetch" href="/study-note/assets/js/8.d95a945c.js"><link rel="prefetch" href="/study-note/assets/js/9.1e4769d3.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.de699857.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/MySQL/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Database/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/study-note/pages/Database/MySQL/" class="sidebar-heading clickable router-link-active open"><span>MySQL 实战 45 讲 </span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/study-note/pages/Database/MySQL/01-MySQL的基础架构.html" class="sidebar-link">01-MySQL 的基础架构</a></li><li><a href="/study-note/pages/Database/MySQL/02-MySQL的日志系统.html" class="sidebar-link">02-MySQL 的日志系统</a></li><li><a href="/study-note/pages/Database/MySQL/03-事务隔离.html" class="sidebar-link">03-事务隔离</a></li><li><a href="/study-note/pages/Database/MySQL/04-深入浅出索引.html" class="active sidebar-link">04-深入浅出索引</a></li><li><a href="/study-note/pages/Database/MySQL/05-MySQL中的锁.html" class="sidebar-link">05-MySQL 中的锁</a></li><li><a href="/study-note/pages/Database/MySQL/06-MVCC.html" class="sidebar-link">06-MVCC</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_04-深入浅出索引"><a href="#_04-深入浅出索引" class="header-anchor">#</a> 04-深入浅出索引</h1> <blockquote><p>数据库底层存储的核心就是基于数据模型。每碰到一个新数据库，我们需要先关注它的数据模型，这样才能从理论上分析出这个数据库的适用场景。</p></blockquote> <p>课程链接：</p> <ul><li><a href="https://time.geekbang.org/column/article/69236" target="_blank" rel="noopener noreferrer">MySQL 实战 45 讲 04 | 深入浅出索引（上）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://time.geekbang.org/column/article/69636" target="_blank" rel="noopener noreferrer">MySQL 实战 45 讲 04 | 深入浅出索引（下）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>内容包括：</p> <ul><li>索引的常见模型
<ul><li>Hash 表</li> <li>有序数组</li> <li>搜索树</li></ul></li> <li>InnoDB 的索引模型</li> <li>覆盖索引</li> <li>最左前缀原则</li> <li>索引下推</li></ul> <h2 id="索引的常见模式"><a href="#索引的常见模式" class="header-anchor">#</a> 索引的常见模式</h2> <p>索引的出现是为了提高查询效率，实现索引的方式有很多种。</p> <h3 id="hash-表"><a href="#hash-表" class="header-anchor">#</a> Hash 表</h3> <p>定义：</p> <ul><li><code>hash</code> 是一种函数，<strong>把任意长度的输入转换为固定长度的输出</strong>，输出的结果称为 hash 值；</li> <li>哈希表是一种以键 - 值（key-value）存储数据的结构，只要输入待查找的键即 key，就可以找到其对应的值即 Value。</li></ul> <p>特性：</p> <ul><li>多个 key 值经过哈希函数的换算，会出现同一个值的情况（<strong>hash 碰撞</strong>）；拉链法解决；</li> <li><strong>适用于只有等值查询的场景</strong>，比如 Memcached 及其他一些 NoSQL 引擎；不适用于范围查询。</li></ul> <p>例子：维护一个身份证信息和姓名的表，根据身份证号查找对应的名字，对应的哈希索引如下所示：</p> <p><img src="http://image.kongxiao.top/20221017232308.png" alt="image-20221017232259767"></p> <p>User2 和 User4 根据身份证号算出来的值都是 N，拉出一个链表。</p> <p>要查 ID_card_n2 对应的名字，首先将 ID_card_n2 通过哈希函数算出 N，然后按顺序遍历找到 User2。</p> <h3 id="有序数组"><a href="#有序数组" class="header-anchor">#</a> 有序数组</h3> <p>适用于等值查询和范围查询场景。</p> <p>例子：假设身份证号没有重复，这个数组就是按照身份证号递增的顺序保存的，如下图所示：</p> <p><img src="http://image.kongxiao.top/20221017232459.png" alt="image-20221017232457985"></p> <p>特性：</p> <ul><li>要查 ID_card_n2 对应的名字，使用<strong>二分法</strong>，时间复杂度 O(log(N))；</li> <li><strong>支持范围查询</strong>。要查身份证号在 [ID_card_X, ID_card_Y] 区间的 User，可以先用二分法找到 ID_card_X（如果不存在 ID_card_X，就找到大于 ID_card_X 的第一个 User），然后向右遍历，直到查到第一个大于 ID_card_Y 的身份证号，退出循环；</li> <li>更新数据时间复杂度为 O(n)，往中间插入一个记录必须挪动后面所有的记录，成本太高，因此<strong>只适用于静态存储引擎</strong>。比如要保存的是 2017 年某个城市的所有人口信息，这类不会再修改的数据。</li></ul> <h3 id="搜索树"><a href="#搜索树" class="header-anchor">#</a> 搜索树</h3> <p>用二叉搜索树来实现：</p> <p><img src="http://image.kongxiao.top/20221017233019.png" alt="image-20221017233018787"></p> <p>二叉搜索树：</p> <ul><li><strong>父节点左子树所有结点的值小于父节点的值，右子树所有结点的值大于父节点的值；</strong></li> <li>查找时间复杂度近似等于二分法，但前提是二叉搜索树近似平衡；</li> <li>二叉搜索树有可能出现极坏的情况，变成链表；</li></ul> <p>平衡二叉树：</p> <ul><li>为了维持 O(log(N)) 的查询复杂度，需要保持这棵树是平衡二叉树，更新的时间复杂度也是 O(log(N))</li></ul> <p>N 叉树：</p> <ul><li>索引不止存在内存中，还要写到磁盘上。如果二叉树树高过高，每次查询都需要访问过多节点；</li> <li>为了让一个查询尽量少地读磁盘，要使用“N 叉”树，“N”取决于数据块的大小。</li></ul> <p>MySQL 默认一个节点的长度为 16K，一个整数（bigint）字段索引的长度为 8B，另外每个索引还跟着 6B 的指向其子树的指针，所以16K/14B ≈ 1170。这棵树高是 4 的时候，就可以存 1170 的 3 次方个值，这已经 16 亿了。</p> <p>参考：https://blog.csdn.net/weixin_35871519/article/details/113303881</p> <h2 id="innodb-的索引模型"><a href="#innodb-的索引模型" class="header-anchor">#</a> InnoDB 的索引模型</h2> <p>在 MySQL 中，索引是在存储引擎层实现的。</p> <p>InnoDB 使用了 <strong>B+ 树索引模型</strong>，数据都是存储在 B+ 树中的。<strong>每一个索引在 InnoDB 里面对应一棵 B+ 树。</strong></p> <p>案例：有一个主键列为 ID 的表 T，表中有字段 k，并且在 k 上有索引。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> T <span class="token punctuation">(</span>
   id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
   k <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> 
   name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">index</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>表中 R1~R5 的 (ID,k) 值分别为 (100,1)、(200,2)、(300,3)、(500,5) 和 (600,6)，两棵索引树的示意图如下：</p> <p><img src="http://image.kongxiao.top/20221024233013.png" alt="image-20221024233004949"></p> <h3 id="b-树和-b-树的区别"><a href="#b-树和-b-树的区别" class="header-anchor">#</a> B+ 树和 B 树的区别</h3> <ul><li>B 树的所有节点既存放 key 也存放 data；B+树只有叶子节点存放 key 和 data，其他内节点只存放 key；</li> <li>B+ 树的叶子节点有一条双向链表串连与它相邻的叶子节点，区间查询效率更高；</li> <li>B+树查询效率更高，因为B+树矮更胖，高度小，减少单次查询的磁盘访问次数。</li></ul> <h3 id="索引的分类"><a href="#索引的分类" class="header-anchor">#</a> 索引的分类</h3> <ul><li><p>从数据结构角度</p> <ul><li>树索引 (O(log(n)))</li> <li>Hash 索引</li></ul></li> <li><p>从功能角度</p> <ul><li>普通索引</li> <li>唯一性索引</li> <li>主键索引</li> <li>全文索引</li></ul></li> <li><p>从物理实现</p> <ul><li>聚簇索引：叶子节点存的是整行数据；InnoDB 的主键索引是聚集索引；</li> <li>非聚簇索引：叶子节点内容是主键的值，也称为二级索引或者辅助索引；</li></ul></li></ul> <h3 id="回表"><a href="#回表" class="header-anchor">#</a> 回表</h3> <p>定义：InnoDB 普通索引的叶子节点存储主键值，查询时需要先定位主键值，再通过主键索引定位行记录</p> <p>基于主键索引和普通索引的查询的区别：</p> <ul><li><code>select * from T where ID=500</code>，即主键查询方式，只需要搜索 ID 这棵 B+ 树；</li> <li><code>select * from T where k=5</code>，即普通索引查询方式，需要先搜索 k 索引树，得到 ID 的值为 500，再到 ID 索引树搜索一次。</li></ul> <p>基于非主键索引的查询需要多扫描一棵索引树，在应用中应该尽量使用主键查询。</p> <h3 id="索引维护"><a href="#索引维护" class="header-anchor">#</a> 索引维护</h3> <p>B+ 树为了维护索引有序性，在插入新值的时候需要做必要的维护：</p> <ul><li>新插入中间值，需要逻辑上挪动后面的数据，空出位置；</li> <li><strong>页分裂</strong>：如果数据页已经满了，需要申请一个新的数据页，然后挪动部分数据过去。会影响性能和数据页的使用率；</li> <li><strong>页合并</strong>：当相邻两个页由于删除了数据，利用率很低之后，会将数据页做合并。</li></ul> <p>建议使用自增长主键作为索引的原因（性能和存储空间）：</p> <ul><li>B+树存储数据的特点是从左到右是有序的，在插入数据时，如果不是有序插入，会导致B+树的叶子节点分裂，存在移动数据的情况，影响插入数据性能；</li> <li>自增长主键在插入过程中能尽量减少页分裂，即使要进行页分裂，也只会分裂很少一部分；减少数据的移动，每次插入都是插入到最后；</li> <li>主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小。</li></ul> <h2 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h2> <p>定义：查询的数据列从索引中就能够取得，不必读取数据行，即<strong>查询列被所建的索引覆盖</strong>。</p> <p>作用：覆盖索引可以减少树的搜索次数，显著提升查询性能，使用覆盖索引是一个常用的性能优化手段。</p> <p>举例：</p> <ul><li>执行 <code>select * from T where k between 3 and 5</code>：
<ol><li>在 k 索引树上找到 k=3 的记录，取得 ID = 300；</li> <li>再到 ID 索引树查到 ID=300 对应的 R3；</li> <li>在 k 索引树取下一个值 k=5，取得 ID=500；</li> <li>再回到 ID 索引树查到 ID=500 对应的 R4；</li> <li>在 k 索引树取下一个值 k=6，不满足条件，循环结束。</li></ol></li></ul> <p>查询过程读了 k 索引树的 3 条记录（步骤 1、3 和 5），回表了两次（步骤 2 和 4）。</p> <ul><li>执行 <code>select ID from T where k between 3 and 5</code>：
<ol><li>只需要查 ID 的值，而 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表</li></ol></li></ul> <h2 id="最左前缀原则"><a href="#最左前缀原则" class="header-anchor">#</a> 最左前缀原则</h2> <p><strong>联合索引</strong>：表上多个列加起来组成一个索引；与在写 where 条件后的顺序无关，MySQL 会查询分析会进行优化而使用索引；联合索引也拥有单列索引的作用。</p> <p>举例：市民信息表如下</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tuser<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ismale<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><code>id_card</code>是市民的唯一标识。根据<code>id_card</code>查询市民信息，则建立索引 (<code>id_card</code>)；</li> <li>如果要根据<code>id_card</code>查询<code>id_card</code>，再建立一个（<code>id_card</code>,<code>name</code>）的联合索引，可以用到覆盖索引，不再需要回表查整行记录；</li></ul> <p>索引字段的维护总是有代价的，在建立冗余索引来支持覆盖索引时就需要权衡考虑。</p> <p><strong>最左前缀原则</strong>：组合索引中，最左优先，以最左边的为起点任何连续的索引都能匹配上。比如说联合索引里有字段 a,b,c 那么 a, ab, abc 都是可以走这个索引。遇到范围查询 (&gt;、&lt;、between、like) 就会停止匹配。</p> <p>举例：（name，age）联合索引</p> <p><img src="http://image.kongxiao.top/20221026232551.png" alt="image-20221026232550280"></p> <ul><li>查到所有 <code>name</code>是“张三”的人时，可以快速定位到 ID4，然后向后遍历得到所有需要的结果；</li> <li>查的<code>name</code>第一个字是“张”的人：<code>where name like ‘张 %’</code>，也能够用上这个索引，查找到第一个符合条件的记录是 ID3，然后向后遍历，直到不满足条件为止；</li></ul> <p>最左前缀可以是联合索引的最左 N 个字段，也可以是字符串索引的最左 M 个字符。</p> <p>在建立联合索引的时候，安排索引内的字段顺序需要考虑的因素：</p> <ul><li><strong>索引的复用能力</strong>。因为可以支持最左前缀，所以当已经有了 (a,b) 这个联合索引后，一般就不需要单独在 a 上建立索引了。如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</li> <li><strong>空间</strong>。如果既有联合查询，又有基于 a、b 各自的查询。(a,b)、(b) 还是 (b,a)、(a)？考虑空间，字段长的只建立一次，短的建立两次。</li></ul> <h2 id="索引下推"><a href="#索引下推" class="header-anchor">#</a> 索引下推</h2> <p>定义：**在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。**MySQL 5.6 引入的索引下推优化。</p> <p>满足最左前缀原则，可以用于在索引中定位记录，而那些不符合最左前缀的部分，如何处理？</p> <p>举例：</p> <p>建立了联合索引（<code>name</code>, <code>age</code>），执行以下 SQL</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tuser <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'张%'</span> <span class="token operator">and</span> age <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">and</span> ismale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>根据前缀索引规则，“张”可以用到联合索引中的 <code>name</code>，找到第一个满足条件的记录 ID3，然后判断其他条件是否满足。</p> <p>在 MySQL 5.6 之前，不会去看 <code>age</code> 的值，只能从 ID3 开始一个个回表，到主键索引上找出数据行，再对比字段值，需要回表 4 次。</p> <p><img src="http://image.kongxiao.top/20221026234024.png" alt="image-20221026234022823"></p> <p>MySQL 5.6 引入索引下推优化。InnoDB 在（<code>name</code>, <code>age</code>） 索引内部就判断了 <code>age</code> 是否等于 10，对于不等于 10 的记录，直接判断并跳过。只需要对 ID4、ID5 这两条记录回表取数据判断，回表 2 次。</p> <p><img src="http://image.kongxiao.top/20221026234040.png" alt="image-20221026234035391"></p> <hr> <p>思考题 1：针对上表 T，如果要重建普通索引 k 或者主键索引，如何理解下面两个 SQL 语句：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment"># 重建索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">drop</span> <span class="token keyword">index</span> k<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">add</span> <span class="token keyword">index</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 重建主键索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">drop</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>为什么要重建索引？</p> <p>因为当对InnoDB进行修改操作时，例如删除一些行，这些行只是被标记为“已删除”，而不是真的从索引中物理删除了，因而空间也没有真的被释放回收。重建索引的过程会创建一个新的索引，把数据按顺序插入，这样页面的利用率最高，也就是索引更紧凑、更省空间。</p></blockquote> <p>答案：重建索引 k 的做法是合理的，可以达到省空间的目的。但是，重建主键的过程不合理。<strong>不论是删除主键还是创建主键，都会将整个表重建</strong>。所以连着执行这两个语句的话，第一个语句就白做了。</p> <p>这两个语句，可以用这个语句代替 ：<code>alter table T engine=InnoDB</code>，这个语句在 InnobDB 里会触发 MySQL 重建该表，并进行碎片处理.</p> <hr> <p>思考题 2：有一个表结构定义如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>geek<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>d<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ca<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>cb<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>b<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>为了以下两个查询模式，“ca”“cb”这两个索引是否都是必须的？</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> geek <span class="token keyword">where</span> c <span class="token operator">=</span> N <span class="token keyword">order</span> <span class="token keyword">by</span> a <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> geek <span class="token keyword">where</span> c <span class="token operator">=</span> N <span class="token keyword">order</span> <span class="token keyword">by</span> b <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>答案：ca 可以去掉，cb 需要保留。</p> <p><strong>二级索引索引扩展</strong>： InnoDB 的二级索引会自动补齐主键，将主键列追加到二级索引列后面，同时也会去重，若主键的部分列已经包含在二级索引中，则不会再重复记录该列。参考：https://dev.mysql.com/doc/refman/5.7/en/index-extensions.html</p> <ol><li>c 字段上创建了索引，所以最终的叶子节点值为(c,a,b)，即索引节点+主键；</li> <li>ca 上创建索引，。所以叶子节点不会再重复添加 a （c,a,a,b），而是（c,a,b）；那么这颗索引树和 1 中的重复了，所以可以去掉；</li> <li>cb 上创建索引，叶子节点为（c,b,a）</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/27/2022, 4:08:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study-note/pages/Database/MySQL/03-事务隔离.html" class="prev">
        03-事务隔离
      </a></span> <span class="next"><a href="/study-note/pages/Database/MySQL/05-MySQL中的锁.html">
        05-MySQL 中的锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/study-note/assets/js/app.663c6fe1.js" defer></script><script src="/study-note/assets/js/2.f98b8d51.js" defer></script><script src="/study-note/assets/js/15.83d11e46.js" defer></script>
  </body>
</html>
