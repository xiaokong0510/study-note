<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Apollo入门 | xiao blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/study-note/logo.png">
    <meta name="description" content="半路出家的 Java 学习之路">
    
    <link rel="preload" href="/study-note/assets/css/0.styles.0a4146bd.css" as="style"><link rel="preload" href="/study-note/assets/js/app.cf42b68c.js" as="script"><link rel="preload" href="/study-note/assets/js/2.a46c0893.js" as="script"><link rel="preload" href="/study-note/assets/js/48.3aee5fe2.js" as="script"><link rel="prefetch" href="/study-note/assets/js/10.70b9e1c3.js"><link rel="prefetch" href="/study-note/assets/js/11.873f24f0.js"><link rel="prefetch" href="/study-note/assets/js/12.24ec706a.js"><link rel="prefetch" href="/study-note/assets/js/13.63a1f1ac.js"><link rel="prefetch" href="/study-note/assets/js/14.ded0c8ff.js"><link rel="prefetch" href="/study-note/assets/js/15.8774dd7b.js"><link rel="prefetch" href="/study-note/assets/js/16.4a8039a2.js"><link rel="prefetch" href="/study-note/assets/js/17.30e90002.js"><link rel="prefetch" href="/study-note/assets/js/18.5d91c0df.js"><link rel="prefetch" href="/study-note/assets/js/19.abcd4bc1.js"><link rel="prefetch" href="/study-note/assets/js/20.f131a49f.js"><link rel="prefetch" href="/study-note/assets/js/21.ef4c6972.js"><link rel="prefetch" href="/study-note/assets/js/22.e81700e0.js"><link rel="prefetch" href="/study-note/assets/js/23.4b340b61.js"><link rel="prefetch" href="/study-note/assets/js/24.15807cb4.js"><link rel="prefetch" href="/study-note/assets/js/25.e2265404.js"><link rel="prefetch" href="/study-note/assets/js/26.4bccdb22.js"><link rel="prefetch" href="/study-note/assets/js/27.acc5a154.js"><link rel="prefetch" href="/study-note/assets/js/28.6303e808.js"><link rel="prefetch" href="/study-note/assets/js/29.4f135e26.js"><link rel="prefetch" href="/study-note/assets/js/3.972304b8.js"><link rel="prefetch" href="/study-note/assets/js/30.b1557a75.js"><link rel="prefetch" href="/study-note/assets/js/31.bc4dac61.js"><link rel="prefetch" href="/study-note/assets/js/32.465825f0.js"><link rel="prefetch" href="/study-note/assets/js/33.cdd29ad2.js"><link rel="prefetch" href="/study-note/assets/js/34.9ca320c9.js"><link rel="prefetch" href="/study-note/assets/js/35.9d4c86ee.js"><link rel="prefetch" href="/study-note/assets/js/36.4da200ad.js"><link rel="prefetch" href="/study-note/assets/js/37.3d0b6aa6.js"><link rel="prefetch" href="/study-note/assets/js/38.e037d465.js"><link rel="prefetch" href="/study-note/assets/js/39.42197d51.js"><link rel="prefetch" href="/study-note/assets/js/4.810a9dda.js"><link rel="prefetch" href="/study-note/assets/js/40.bd5a2c07.js"><link rel="prefetch" href="/study-note/assets/js/41.cda0b71f.js"><link rel="prefetch" href="/study-note/assets/js/42.0f5498a3.js"><link rel="prefetch" href="/study-note/assets/js/43.58cf8781.js"><link rel="prefetch" href="/study-note/assets/js/44.7b941b05.js"><link rel="prefetch" href="/study-note/assets/js/45.5fa838dc.js"><link rel="prefetch" href="/study-note/assets/js/46.659efba2.js"><link rel="prefetch" href="/study-note/assets/js/47.87c31dde.js"><link rel="prefetch" href="/study-note/assets/js/49.866b5e73.js"><link rel="prefetch" href="/study-note/assets/js/5.7b7c443b.js"><link rel="prefetch" href="/study-note/assets/js/50.d2e81187.js"><link rel="prefetch" href="/study-note/assets/js/6.723ea6d4.js"><link rel="prefetch" href="/study-note/assets/js/7.33a4fc23.js"><link rel="prefetch" href="/study-note/assets/js/8.915c66d9.js"><link rel="prefetch" href="/study-note/assets/js/9.ec1dee1c.js">
    <link rel="stylesheet" href="/study-note/assets/css/0.styles.0a4146bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study-note/" class="home-link router-link-active"><img src="/study-note/logo.png" alt="xiao blog" class="logo"> <span class="site-name can-hide">xiao blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Databases/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Databases/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study-note/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/study-note/pages/ComputerBasics/" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><a href="/study-note/pages/DataStructures&amp;Algorithms/" class="nav-link">
  数据结构与算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/basic/" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/concurrent/" class="nav-link">
  并发
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Java/JVM/" class="nav-link">
  JVM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Databases/MySQL/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Databases/Redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SSM/" class="nav-link">
  SSM
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringBoot/" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/study-note/pages/Framework/SpringCloud/" class="nav-link">
  SpringCloud
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study-note/pages/more/tools/" class="nav-link">
  工具
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaokong0510" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="apollo入门"><a href="#apollo入门" class="header-anchor">#</a> Apollo入门</h1> <p>公司项目使用了Apollo配置中心，找了个入门视频学习一下。只是一些基本的操作，架构有待深入研究。内容包括：</p> <ol><li>Apollo 的工作流程</li> <li>Apollo 的4个维度管理 Key-Value 格式的配置：
<ul><li>application (应用)</li> <li>environment (环境)</li> <li>cluster (集群)</li> <li>namespace (命名空间)</li></ul></li> <li>WSL2下 docker 部署apollo</li> <li>SpringBoot 集成Apollo的使用方法</li></ol> <ul><li><p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener noreferrer">git地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.apolloconfig.com/#/zh/design/apollo-introduction" target="_blank" rel="noopener noreferrer">中文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.bilibili.com/video/BV1eE41187sS" target="_blank" rel="noopener noreferrer">B站 黑马轻松入门Apollo分布式配置中心<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="http://www.pbteach.com/post/java_distribut/apollo_yq_doc/" target="_blank" rel="noopener noreferrer">配套讲义<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h2 id="_1-配置和配置中心"><a href="#_1-配置和配置中心" class="header-anchor">#</a> 1. 配置和配置中心</h2> <p>配置主要有以下几个特点：</p> <ul><li>配置是独立于程序的只读变量：独立于程序的，对于程序是只读的</li> <li>配置伴随应用的整个生命周期：启动、运行</li> <li>配置可以有多种加载方式：程序内部硬编码，配置文件，环境变量，启动参数，基于数据库等</li> <li>配置需要治理：权限控制、不同环境和集群配置管理</li></ul> <p>微服务化的过程中，当系统从一个单体应用被拆分成分布式系统上一个个服务节点后，配置文件也必须跟着分割，这样配置就分散了。<strong>配置中心将配置从应用中剥离出来，统一管理，优雅的解决了配置的动态变更、持久化、运维成本等问题</strong>。应用自身既不需要去添加管理配置接口，也不需要自己去实现配置的持久化，更不需要引入“定时任务”以便降低运维成本。 <strong>即，配置中心就是一种统一管理各种应用配置的基础服务组件。</strong></p> <p>一个合格的配置中心需要满足一下几个特点：</p> <ul><li>配置项容易读取和修改</li> <li>添加新配置简单直接</li> <li>支持对配置的修改的检视以把控风险</li> <li>可以查看配置修改的历史记录</li> <li>不同部署环境支持隔离</li></ul> <h2 id="_2-apollo入门"><a href="#_2-apollo入门" class="header-anchor">#</a> 2. Apollo入门</h2> <h3 id="_2-1-主流配置中心"><a href="#_2-1-主流配置中心" class="header-anchor">#</a> 2.1 主流配置中心</h3> <ul><li><p>Disconf，百度</p></li> <li><p>Spring Cloud Config，Spring Cloud 生态组件，可以和Spring Cloud体系无缝整合。</p></li> <li><p>Apollo，携程</p></li> <li><p>Nacos，阿里</p></li></ul> <h3 id="_2-2-apollo特性"><a href="#_2-2-apollo特性" class="header-anchor">#</a> 2.2 Apollo特性</h3> <ul><li><strong>统一管理不同环境、不同集群的配置</strong> <ul><li>Apollo提供了一个统一界面集中式管理不同环境（environment）、不同集群（cluster）、不同命名空间（namespace）的配置。</li> <li>同一份代码部署在不同的集群，可以有不同的配置，比如zookeeper的地址等</li> <li>通过命名空间（namespace）可以很方便地支持多个不同应用共享同一份配置，同时还允许应用对共享的配置进行覆盖</li></ul></li> <li><strong>配置修改实时生效（热发布）</strong> <ul><li>用户在Apollo修改完配置并发布后，客户端能实时（1秒）接收到最新的配置，并通知到应用程序</li></ul></li> <li><strong>版本发布管理</strong> <ul><li>所有的配置发布都有版本概念，从而可以方便地支持配置的回滚</li></ul></li> <li><strong>灰度发布</strong> <ul><li>支持配置的灰度发布，比如点了发布后，只对部分应用实例生效，等观察一段时间没问题后再推给所有应用实例</li></ul></li> <li><strong>权限管理、发布审核、操作审计</strong> <ul><li>应用和配置的管理都有完善的权限管理机制，对配置的管理还分为了编辑和发布两个环节，从而减少人为的错误。</li> <li>所有的操作都有审计日志，可以方便地追踪问题</li></ul></li> <li><strong>客户端配置信息监控</strong> <ul><li>可以在界面上方便地看到配置在被哪些实例使用</li></ul></li> <li><strong>提供Java和.Net原生客户端</strong> <ul><li>提供了Java和.Net的原生客户端，方便应用集成</li> <li>支持Spring Placeholder, Annotation和Spring Boot的ConfigurationProperties，方便应用使用（需要Spring 3.1.1+）</li> <li>同时提供了Http接口，非Java和.Net应用也可以方便地使用</li></ul></li> <li><strong>提供开放平台API</strong> <ul><li>Apollo自身提供了比较完善的统一配置管理界面，支持多环境、多数据中心配置管理、权限、流程治理等特性。不过Apollo出于通用性考虑，不会对配置的修改做过多限制，只要符合基本的格式就能保存，不会针对不同的配置值进行针对性的校验，如数据库用户名、密码，Redis服务地址等</li> <li>对于这类应用配置，Apollo支持应用方通过开放平台API在Apollo进行配置的修改和发布，并且具备完善的授权和权限控制</li></ul></li></ul> <p><strong>Apollo的执行流程：</strong></p> <p><img src="http://image.kongxiao.top/image-20200624231416294.png" alt="image-20200624231416294"></p> <ul><li>用户在配置中心对配置进行修改并发布</li> <li>Apollo配置中心会向客户端推送最新的配置</li> <li>Apollo客户端会定时从Apollo配置中心拉取最新的配置、更新本地配置并通知到应用</li></ul> <h3 id="_2-3-快速开始"><a href="#_2-3-快速开始" class="header-anchor">#</a> 2.3 快速开始</h3> <p>Quick Start需要有bash环境，Windows用户安装Git Bash</p> <h4 id="_01-环境要求"><a href="#_01-环境要求" class="header-anchor">#</a> 01 环境要求</h4> <p>Java</p> <ul><li>Apollo服务端：1.8+</li> <li>Apollo客户端：1.7+</li></ul> <p>MySQL：</p> <ul><li>版本要求：5.6.5+，Apollo的表结构对<code>timestamp</code>使用了多个default声明，所以需要5.6.5以上版本。</li></ul> <h4 id="_02-下载quick-start安装包"><a href="#_02-下载quick-start安装包" class="header-anchor">#</a> 02 下载Quick Start安装包</h4> <p>下载地址：https://github.com/nobodyiam/apollo-build-scripts</p> <ol><li>apollo-configservice</li> <li>apollo-adminservice</li> <li>apollo-portal</li></ol> <h4 id="_03-创建数据库"><a href="#_03-创建数据库" class="header-anchor">#</a> 03 创建数据库</h4> <p>Apollo服务端共需要两个数据库：<code>ApolloPortalDB</code> 和<code>ApolloConfigDB</code>，ApolloPortalDB 只需要在生产环境部署一个即可，<strong>而ApolloConfigDB 需要在每个环境部署一套。</strong></p> <p><strong>ApolloPortalDB</strong>：</p> <p><a href="https://github.com/apolloconfig/apollo-build-scripts/blob/master/sql/apolloportaldb.sql" target="_blank" rel="noopener noreferrer">apolloportaldb.sql<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>导入apolloportaldb.sql成功后，可以通过执行以下sql语句来验证：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select `Id`, `AppId`, `Name` from ApolloPortalDB.App;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><table><thead><tr><th>Id</th> <th>AppId</th> <th>Name</th></tr></thead> <tbody><tr><td>1</td> <td>SampleApp</td> <td>Sample App</td></tr></tbody></table> <p><strong>ApolloConfigDB</strong>：</p> <p><a href="https://github.com/apolloconfig/apollo-build-scripts/blob/master/sql/apolloconfigdb.sql" target="_blank" rel="noopener noreferrer">apolloconfigdb.sql<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>导入apolloconfigdb.sql 成功后，可以通过执行以下sql语句来验证：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>select `NamespaceId`, `Key`, `Value`, `Comment` from ApolloConfigDB.Item;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><table><thead><tr><th>NamespaceId</th> <th>Key</th> <th>Value</th> <th>Comment</th></tr></thead> <tbody><tr><td>1</td> <td>timeout</td> <td>100</td> <td>sample timeout配置</td></tr></tbody></table> <h4 id="_04-配置数据库连接信息"><a href="#_04-配置数据库连接信息" class="header-anchor">#</a> 04 配置数据库连接信息</h4> <p>编辑 <a href="https://github.com/nobodyiam/apollo-build-scripts/blob/master/demo.sh" target="_blank" rel="noopener noreferrer">demo.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，修改 ApolloPortalDB 和 ApolloConfigDB 相关的数据库连接信息。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># apollo config db info</span>
<span class="token assign-left variable">apollo_config_db_url</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding<span class="token operator">=</span>utf8
<span class="token assign-left variable">apollo_config_db_username</span><span class="token operator">=</span>username
<span class="token assign-left variable">apollo_config_db_password</span><span class="token operator">=</span>password

<span class="token comment"># apollo portal db info</span>
<span class="token assign-left variable">apollo_portal_db_url</span><span class="token operator">=</span>jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding<span class="token operator">=</span>utf8
<span class="token assign-left variable">apollo_portal_db_username</span><span class="token operator">=</span>username
<span class="token assign-left variable">apollo_portal_db_password</span><span class="token operator">=</span>password
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_05-启动"><a href="#_05-启动" class="header-anchor">#</a> 05 启动</h4> <p>Apollo默认会启动3个服务，分别使用8070, 8080, 8090端口，确保这3个端口当前没有被使用。执行启动命令：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>./demo.sh start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>apollo-configservice  8080</li> <li>apollo-adminservice  8090</li> <li>apollo-portal  8070</li></ol> <p><img src="http://image.kongxiao.top/image-20200627112616194.png" alt="image-20200627112616194"></p> <p>启动成功后，通过 http://localhost:8070 就可以访问，登录名/密码：  apollo/admin</p> <p>SampleApp进入配置界面，可以看到当前有一个配置 timeout=100。</p> <p><img src="http://image.kongxiao.top/image-20200627113400493.png" alt="image-20200627113400493"></p> <h4 id="_06-运行客户端程序"><a href="#_06-运行客户端程序" class="header-anchor">#</a> 06 运行客户端程序</h4> <p>启动Demo客户端：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>./demo.sh client
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>输入<code>timeout</code>，就可以取到对应配置的值：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>sh<span class="token operator">&gt;</span> <span class="token function">timeout</span>
<span class="token operator">&gt;</span> <span class="token punctuation">[</span>SimpleApolloConfigDemo<span class="token punctuation">]</span> Loading key <span class="token builtin class-name">:</span> <span class="token function">timeout</span> with value: <span class="token number">100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="http://image.kongxiao.top/image-20200627113144308.png" alt="image-20200627113144308"></p> <h3 id="_2-4-docker方式部署"><a href="#_2-4-docker方式部署" class="header-anchor">#</a> 2.4 Docker方式部署</h3> <p>我本机环境是 Win10，安装了 WSL2，Docker 可以直接跑在里面，以此为环境。</p> <p>文档可参考：<a href="https://docs.microsoft.com/zh-cn/windows/wsl/install-win10" target="_blank" rel="noopener noreferrer">WSL2官方安装教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="_01-数据库准备"><a href="#_01-数据库准备" class="header-anchor">#</a> 01 数据库准备</h4> <p>Docker 部署mysql，可参考之前的博客 <a href="http://www.kongxiao.top/archives/docker-baseuse" target="_blank" rel="noopener noreferrer">Docker基本操作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>需要注意的是，要使用 ifconfig 查看 WSL的 ip地址。</p> <p>主机也可以用 localhost 连接上 WSL2，但是 WSL2 内部使用 localhost 连不上自己，因此后面的数据库 ip  都使用了下面的ip。(貌似重启这个ip会改变)</p></blockquote> <p><img src="http://image.kongxiao.top/image-20210716142200559.png" alt="image-20210716142200559"></p> <h4 id="_02-apollo-config-service"><a href="#_02-apollo-config-service" class="header-anchor">#</a> 02  Apollo Config Service</h4> <ul><li><p><strong>apollo-configservice 本身就是一个 eureka 服务</strong></p></li> <li><p>apollo-configservice 、 apollo-adminservice 都需要向 eureka 服务注册</p></li> <li><p><strong>配置项统一存储在 ApolloConfigDB.ServerConfig 表中，其中 eureka.service.url 表示 eureka 服务地址</strong></p></li></ul> <p>获取镜像</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> pull apolloconfig/apollo-configservice:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行镜像</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> run -p <span class="token number">8080</span>:8080 <span class="token punctuation">\</span>
    -e <span class="token assign-left variable">SPRING_DATASOURCE_URL</span><span class="token operator">=</span><span class="token string">&quot;jdbc:mysql://172.26.100.204:3306/ApolloConfigDB?characterEncoding=utf8&quot;</span> <span class="token punctuation">\</span>
    -e <span class="token assign-left variable">SPRING_DATASOURCE_USERNAME</span><span class="token operator">=</span>root -e <span class="token assign-left variable">SPRING_DATASOURCE_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>
    -d -v /tmp/logs:/opt/logs --name apollo-configservice apolloconfig/apollo-configservice:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数说明：</p> <ul><li>SPRING_DATASOURCE_URL: 对应环境ApolloConfigDB的地址</li> <li>SPRING_DATASOURCE_USERNAME: 对应环境ApolloConfigDB的用户名</li> <li>SPRING_DATASOURCE_PASSWORD: 对应环境ApolloConfigDB的密码</li></ul> <h4 id="_03-apollo-admin-service"><a href="#_03-apollo-admin-service" class="header-anchor">#</a> 03 Apollo Admin Service</h4> <ul><li><strong>配置项统一存储在 ApolloConfigDB.ServerConfig 表中，其中 eureka.service.url 表示 eureka 服务地址</strong>，即 apollo-configservice 的地址</li> <li>这里需要修改为 01 步中提到的 ip地址，否则服务注册不上，是个坑</li></ul> <p><img src="http://image.kongxiao.top/image-20210716144817807.png" alt="image-20210716144817807"></p> <p>获取镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull apolloconfig/apollo-adminservice:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -p 8090:8090 \
    -e SPRING_DATASOURCE_URL=&quot;jdbc:mysql://172.26.100.204:3306/ApolloConfigDB?characterEncoding=utf8&quot; \
    -e SPRING_DATASOURCE_USERNAME=root -e SPRING_DATASOURCE_PASSWORD=123456 \
    -d -v /tmp/logs:/opt/logs --name apollo-adminservice apolloconfig/apollo-adminservice:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>参数说明：</p> <ul><li>SPRING_DATASOURCE_URL: 对应环境ApolloConfigDB的地址</li> <li>SPRING_DATASOURCE_USERNAME: 对应环境ApolloConfigDB的用户名</li> <li>SPRING_DATASOURCE_PASSWORD: 对应环境ApolloConfigDB的密码</li></ul> <h4 id="_04-apollo-portal"><a href="#_04-apollo-portal" class="header-anchor">#</a> 04 Apollo Portal</h4> <p>获取镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker pull apolloconfig/apollo-portal:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>运行镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run -p 8070:8070 \
    -e SPRING_DATASOURCE_URL=&quot;jdbc:mysql://172.26.100.204:3306/ApolloPortalDB?characterEncoding=utf8&quot; \
    -e SPRING_DATASOURCE_USERNAME=root -e SPRING_DATASOURCE_PASSWORD=123456 \
    -e APOLLO_PORTAL_ENVS=dev \
    -e DEV_META=http://172.26.100.204:8080 \
    -d -v /tmp/logs:/opt/logs --name apollo-portal apolloconfig/apollo-portal:1.7.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>参数说明：</p> <ul><li>SPRING_DATASOURCE_URL: 对应环境 ApolloPortalDB 的地址</li> <li>SPRING_DATASOURCE_USERNAME: 对应环境 ApolloPortalDB 的用户名</li> <li>SPRING_DATASOURCE_PASSWORD: 对应环境 ApolloPortalDB 的密码</li> <li>APOLLO_PORTAL_ENVS(可选): 对应 ApolloPortalDB 中的 apollo.portal.envs 配置项，如果没有在数据库中配置的话，可以通过此环境参数配置</li> <li>DEV_META/PRO_META(可选): 配置对应环境的 Meta Service 地址，以${ENV}_META命名，需要注意的是如果配置了 ApolloPortalDB 中的apollo.portal.meta.servers 配置，则以 apollo.portal.meta.servers 中的配置为准</li></ul> <h4 id="_05-配置多环境"><a href="#_05-配置多环境" class="header-anchor">#</a> 05 配置多环境</h4> <blockquote><p>一套Portal可以管理多个环境，但是每个环境都需要独立部署一套Config Service、Admin Service和ApolloConfigDB</p></blockquote> <p>因此需要新建一张表 ApolloConfigDB_pro 保存 pro 环境的信息，并再起一套Config Service、Admin Service</p> <p>ApolloConfigDB_pro 表中的  eureka.service.url  也需要做相应的修改</p> <p><img src="http://image.kongxiao.top/image-20210716163808379.png" alt="image-20210716163808379"></p> <h3 id="_2-5-核心概念"><a href="#_2-5-核心概念" class="header-anchor">#</a> 2.5 核心概念</h3> <ul><li><p>application (应用)</p> <p>就是实际使用配置的应用，<strong>每个应用都需要有唯一的身份标识 -- AppId</strong>，要使用相应的配置时，需要在代码中指定AppId</p></li> <li><p>environment (环境)</p> <p>配置对应的环境，比如生产环境、开发环境等。环境和代码无关，同一份代码部署在不同的环境就应该能够获取到不同环境的配置</p></li> <li><p>cluster (集群)</p> <p>一个应用下不同实例的分组，比如典型的可以按照数据中心分，把上海机房的应用实例分为一个集群，把北京机房的应用实例分为另一个集群。对不同的cluster，同一个配置可以有不一样的值，即进行值覆盖。</p></li> <li><p>namespace (命名空间)</p> <p>一个应用下不同配置的分组，可以简单地把namespace类比为文件，不同类型的配置存放在不同的文件中，如数据库配置文件等。分为public和private，public可以被其他应用关联，private只能被所属的应用获取到</p></li></ul> <h2 id="_3-java客户端使用"><a href="#_3-java客户端使用" class="header-anchor">#</a> 3. Java客户端使用</h2> <h3 id="_3-1-发布配置"><a href="#_3-1-发布配置" class="header-anchor">#</a> 3.1 发布配置</h3> <p>新建项目，指定<strong>唯一的身份标识 -- AppId</strong>后，可以进行配置发布。支持的单个key-value形式输入，也可以直接使用文本模式批量添加、修改。</p> <p>新增或者修改配置后，都需要点击发布才能生效。</p> <p><img src="http://image.kongxiao.top/image-20210716174942416.png" alt="image-20210716174942416"></p> <h3 id="_3-2-springboot集成方式获取配置"><a href="#_3-2-springboot集成方式获取配置" class="header-anchor">#</a> 3.2 SpringBoot集成方式获取配置</h3> <p>架构图：</p> <p><img src="http://image.kongxiao.top/image-20200627115949993.png" alt="image-20200627115949993"></p> <p>Apollo支持应用在不同的环境有不同的配置，所以需要在运行提供给Apollo客户端当前环境的Apollo Meta Server信息。默认情况下，meta server和config service是部署在同一个JVM进程，所以meta server的地址就是config service的地址。</p> <h4 id="_01-添加apollo客户端依赖"><a href="#_01-添加apollo客户端依赖" class="header-anchor">#</a> 01 添加apollo客户端依赖</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ctrip.framework.apollo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>apollo-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_02-指定appid"><a href="#_02-指定appid" class="header-anchor">#</a> 02 指定AppId</h4> <p>在Spring Boot application.yml 中配置</p> <p>application.yml：</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code> <span class="token comment">#指定appid</span>
<span class="token key atrule">app</span><span class="token punctuation">:</span>
  <span class="token key atrule">id</span><span class="token punctuation">:</span> test
<span class="token key atrule">apollo</span><span class="token punctuation">:</span>
  <span class="token key atrule">bootstrap</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#将Apollo配置加载提到初始化日志系统之前</span>
    <span class="token key atrule">eagerLoad</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> application   <span class="token comment">#指定命名空间</span>
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default
  <span class="token key atrule">cacheDir</span><span class="token punctuation">:</span> /tmp/apollo<span class="token punctuation">-</span>cache   <span class="token comment">#缓存路径</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_03-apollo-meta-server"><a href="#_03-apollo-meta-server" class="header-anchor">#</a> 03 Apollo Meta Server</h4> <p>Apollo支持应用在不同的环境有不同的配置，常用的指定方式有如下两种：</p> <ul><li><p>第一种：配置VM options：<code>-Denv=DEV -Dapollo_meta=http://172.26.100.204:8080</code></p></li> <li><p>第二种：在resources目录下新建apollo-env.properties文件，可配置多套环境，需要配合环境参数使用</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">dev.meta</span><span class="token punctuation">=</span><span class="token value attr-value">http://172.26.100.204:8080</span>
<span class="token key attr-name">pro.meta</span><span class="token punctuation">=</span><span class="token value attr-value">http://172.26.100.204:8081</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h4 id="_04-environment"><a href="#_04-environment" class="header-anchor">#</a> 04 Environment</h4> <p>通过 VM options 的env来指定环境：<code>-Denv=DEV</code></p> <p>配合 apollo-env.properties文件可以切换不同的环境</p> <h4 id="_05-本地缓存路径"><a href="#_05-本地缓存路径" class="header-anchor">#</a> 05 本地缓存路径</h4> <p>Apollo客户端会把从服务端获取到的配置在本地文件系统缓存一份，用于在遇到服务不可用，或网络不通的时候，依然能从本地恢复配置，不影响应用正常运行。本地配置文件会以下面的文件名格式放置于配置的本地缓存路径下：{appId}+{cluster}+{namespace}.properties</p> <p>可以通过 VM options 的apollo.cacheDir指定缓存路径，</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name"> -Dapollo.cacheDir</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/data/apollo-config</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_06-cluster-集群"><a href="#_06-cluster-集群" class="header-anchor">#</a> 06 Cluster（集群）</h4> <p>通过Java System Property的apollo.cluste来指定集群：<code>-Dapollo.cluster=DEFAULT</code></p> <h4 id="_07-通过系统配置文件"><a href="#_07-通过系统配置文件" class="header-anchor">#</a> 07 通过系统配置文件</h4> <p>还可以通过配置文件来指定 <code>env=YOUR-ENVIRONMENT</code></p> <ul><li>对于Mac/Linux，默认文件位置为 <code>/opt/settings/server.properties</code></li> <li>对于Windows，默认文件位置为<code>C:\opt\settings\server.properties</code></li></ul> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">env</span><span class="token punctuation">=</span><span class="token value attr-value">DEV</span>
<span class="token key attr-name">apollo.meta</span><span class="token punctuation">=</span><span class="token value attr-value">http://172.26.100.204:8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="_4-灰度发布"><a href="#_4-灰度发布" class="header-anchor">#</a> 4. 灰度发布</h2> <ol><li>对于一些对程序有比较大影响的配置，可以先在一个或者多个实例生效，观察一段时间没问题后再全量发布配置。</li> <li>对于一些需要调优的配置参数，可以通过灰度发布功能来实现A/B测试。可以在不同的机器上应用不同的配置，不断调整、测评一段时间后找出较优的配置再全量发布配置。</li></ol> <p>通过创建灰度版本，可以对某些配置做灰度测试</p> <p>灰度流程为:</p> <ol><li>创建灰度版本</li> <li>配置灰度配置项</li> <li>配置灰度规则。如果是私有的namespace可以按照客户端的IP进行灰度，如果是公共的namespace则可以同时按AppId和客户端的IP进行灰度</li> <li>灰度发布
灰度版本最终有两种结果:<strong>全量发布和放弃灰度</strong> <strong>全量发布</strong>:灰度的配置合到主版本并发布，所有的客户端都会使用合并后的配置
<strong>放弃灰度</strong>:删除灰度版本，所有的客户端都会使用回主版本的配置
注意事项:如果灰度版本已经有灰度发布过，那么修改灰度规则后，无需再次灰度发布就立即生效</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/14/2022, 1:08:51 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/study-note/assets/js/app.cf42b68c.js" defer></script><script src="/study-note/assets/js/2.a46c0893.js" defer></script><script src="/study-note/assets/js/48.3aee5fe2.js" defer></script>
  </body>
</html>
